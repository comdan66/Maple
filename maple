#!/usr/bin/env php
<?php

// 定義時區
date_default_timezone_set('Asia/Taipei');

define('PATH', realpath(getcwd()) . DIRECTORY_SEPARATOR);
define('CLI_LEN', 80);
define('VERSION', '4.0.13');
define('DEPLOY', array_filter($argv, function($t) { return $t == '--deploy'; }) ? true : false);

if (!function_exists('isJson')) {
  function isJson(&$string, $array = true) {
   $string = json_decode($string, $array);
   return json_last_error() === JSON_ERROR_NONE;
  }
}

if (!function_exists('cc')) {
  function cc($str, $fontColor = null, $backgroundColor = null, $options = []) {
    if ($str === "")
      return "";

    $colors = ['n' => '30', 'r' => '31', 'g' => '32', 'y' => '33', 'b' => '34', 'p' => '35', 'c' => '36', 'w' => '37'];
    $styles = ['underline' => '4', 'blink' => '5', 'reverse' => '7', 'hidden' => '8',
               'u' => '4',         'b' => '5',     'r' => '7',       'h' => '8'];

    $tmps = [];

    is_array($options) || $options = array_filter(array_map('trim', explode(',', $options)));

    if ($options = array_map('strtolower', $options))
      foreach ($options as $style)
        isset($styles[$style]) && array_push($tmps, ["\033[" . $styles[$style] . "m", "\033[0m"]);

    if ($backgroundColor !== null) {
      $c = $backgroundColor[0];
      $c = strtolower($c);
      isset($colors[$c]) && array_push($tmps, ["\033[" . ($colors[$c] + 10) . "m", "\033[0m"]);
    }

    if ($fontColor !== null) {
      strlen($fontColor) > 1 || $fontColor .= '_';
      list($c, $w) = str_split($fontColor);

      $w = $w === '_' ? ctype_upper($c) ? '2' : $w : $w;
      $c = strtolower($c);

      in_array($w, ['0', '1', '2']) || $w = '1';
      $w = $w !== '0' ? $w === '1' ? '0' : '1' : '2';

      isset($colors[$c]) && array_push($tmps, ["\033[" . $w . ';' . $colors[$c] . "m", "\033[0m"]);
    }

    foreach ($tmps as $tmp)
      $str = $tmp[0] . $str . $tmp[1];

    return $str;
  }
}

if (!function_exists('sr')) {
  function sr($input, $multiplier) {
    return str_repeat($input, $multiplier);
  }
}

if (!function_exists('fileRead')) {
  function fileRead($file) {
    if (!file_exists($file))
      return false;

    if (function_exists('file_get_contents'))
      return @file_get_contents($file);

    $fp = @fopen($file, FOPEN_READ);
    
    if ($fp === false)
      return false;

    flock($fp, LOCK_SH);

    $data = '';
    if (filesize($file) > 0)
      $data =& fread($fp, filesize($file));

    flock($fp, LOCK_UN);
    fclose($fp);

    return $data;
  }
}

if (!function_exists('index')) {
  function index() {
    if (defined('MAPLE'))
      return;

    define('MAPLE', '1.0.0');

    define('PATH_SYS',        PATH .     'sys'         . DIRECTORY_SEPARATOR); // sys 絕對位置
    define('PATH_LOG',        PATH .     'log'         . DIRECTORY_SEPARATOR); // log 絕對位置
    define('PATH_TMP',        PATH .     'tmp'         . DIRECTORY_SEPARATOR); // tmp 絕對位置
    define('PATH_CACHE',      PATH .     'cache'       . DIRECTORY_SEPARATOR); // cache 絕對位置
    define('PATH_SESSION',    PATH .     'session'     . DIRECTORY_SEPARATOR); // session 絕對位置
    define('PATH_DOC',        PATH .     'doc'         . DIRECTORY_SEPARATOR); // doc 絕對位置
    define('PATH_APP',        PATH .     'app'         . DIRECTORY_SEPARATOR); // app 絕對位置
    define('PATH_LIB',        PATH_APP . 'lib'         . DIRECTORY_SEPARATOR); // lib 絕對位置
    define('PATH_FUNC',       PATH_APP . 'func'        . DIRECTORY_SEPARATOR); // func 絕對位置
    define('PATH_CORE',       PATH_APP . 'core'        . DIRECTORY_SEPARATOR); // core 絕對位置
    define('PATH_ROUTER',     PATH_APP . 'router'      . DIRECTORY_SEPARATOR); // router 絕對位置
    define('PATH_CONTROLLER', PATH_APP . 'controller'  . DIRECTORY_SEPARATOR); // controller 絕對位置
    define('PATH_MIGRATION',  PATH_APP . 'migration'   . DIRECTORY_SEPARATOR); // migration 絕對位置
    define('PATH_VIEW',       PATH_APP . 'view'        . DIRECTORY_SEPARATOR); // view 絕對位置
    define('PATH_MODEL',      PATH_APP . 'model'       . DIRECTORY_SEPARATOR); // model 絕對位置
    define('PATH_SYS_CORE',   PATH_SYS . 'core'        . DIRECTORY_SEPARATOR); // sys core 絕對位置
    define('PATH_SYS_LIB',    PATH_SYS . 'lib'         . DIRECTORY_SEPARATOR); // sys lib 絕對位置
    define('PATH_SYS_FUNC',   PATH_SYS . 'func'        . DIRECTORY_SEPARATOR); // sys func 絕對位置
    define('PATH_SYS_MODEL',  PATH_SYS . 'model'       . DIRECTORY_SEPARATOR); // sys model 絕對位置
    define('PATH_SYS_CMD',    PATH_SYS . 'cmd'         . DIRECTORY_SEPARATOR); // sys cmd 絕對位置

    if (!@include_once PATH_SYS_CORE . 'Common.php')
      exit('載入 Common 失敗！');
    
    defined('ENVIRONMENT') || Load::path('env.php') || gg('載入環境常數失敗！');

    Load::sysCore('View.php')       || gg('載入 View 失敗！');
    Load::sysCore('Charset.php')    || gg('載入 Charset 失敗！');
    Load::sysCore('Log.php')        || gg('載入 Log 失敗！');
    Load::sysCore('Model.php')      || gg('載入 Model 失敗！');
    Load::sysCore('Url.php')        || gg('載入 Url 失敗！');
    Load::sysFunc('file.php')       || gg('載入 file.php 失敗！');

    return true;
  }
}

if (!function_exists('quit')) {
  function quit() {
    exit(
      "\n\n" . "  好的，期待您下一次的光臨！ 波掰～ :)\n\n\n");
  }
}

if (!function_exists('strLenInfos')) {
  function strLenInfos($val) {
    $tmp = array_filter(preg_split('//u', $val), function($t) { return $t !== ''; });
    return [$val, array_sum(array_map(function($t) { return strlen($t) == 3 ? 2 : 1; }, $tmp)), array_sum(array_map('strlen', $tmp))];
  }
}

if (!function_exists('menu')) {
  function menu($infos, $items, $cho = null) {
    $text = function($cho, $infos, $items) {

      system('clear');
      echo DEPLOY ? '' : Logo::show();

      foreach ($infos as $title => $info) {
        echo "\n " . cc($title, 'y') . "\n";

        if (is_callable($info))
          foreach ($info() as $desc)
          echo $desc . "\n";

        foreach ($info as $desc)
          echo sr(' ', 4) . cc('➤ ', 'c2') . $desc . "\n";
      }

      foreach ($items as $item) {
        echo "\n " . cc($item['title'], 'y') . "\n";

        foreach ($item['items'] as $key => &$val) {
          $val[0] = strLenInfos($val[0]);
          $val[1] = strLenInfos($val[1]);
          $val[2] = strLenInfos(!empty($val[2]) ? $val[2] : '');
          $val[0][1] += ($val[2][1] ? 1 + $val[2][1] : 0);
          $val[0][2] += ($val[2][2] ? 1 + $val[2][2] : 0);
        }

        $xLen = max(array_column(array_column($item['items'], 0), 1));

        foreach ($item['items'] as $key => $item)
          echo cc($cho == $key ? ' ➜' : '  ', 'g1') . cc('  ' . $key . '. ' . sprintf('%-' . ($xLen + ($item[0][2] - $item[0][1]) + ($item[2][2] ? 20 : 0)) . 's', $item[0][0] . ($item[2][0] ? ' ' . cc($item[2][0], 'W', 'r') : '')), $cho == $key ? 'g2' : null) . cc(' - ' . $item[1][0],  $cho == $key ? 'g0' : 'w0') . "\n";
      }
      return $cho;
    };

    $keys = array_keys($items[0]['items']);
    $quit = end($keys);

    if (in_array($cho, $keys))
      return $text($cho, $infos, $items);
    
    while (!in_array($cho, $keys)) {
      $text($cho, $infos, $items);

      echo "\n " . cc('➜', 'R') . ' 請輸入您的選項' .  cc('(' . $quit . ')', 'w0') . '：';
      $cho = strtolower(trim(fgets(STDIN)));
      $cho || $cho = $quit;
    };

    return $cho;
  }
}

if (!function_exists('ctrlC')) {
  function ctrlC() {
    return '過程中若要離開 Maple 請直接按下鍵盤上的 ' . cc('control', 'W') . cc(' + ', 'w0') . cc('c', 'W') . "\n" . sr(' ', 46) . cc('^^^^^^^^^^^', 'c1');
  }
}

if (!function_exists('progress')) {
  function progress($c = null) {
    static $title;
    static $index;
    static $total;

    if (is_string($c))
      return $c === '' || $c === '_' ? $title . cc('(' . number_format($total) . '/' . number_format($total) . ')', 'w0') . cc(' ─ ', 'N') . sprintf('% 3d%%', 100) . cc(' ─ ', 'N') . ($c === '_' ? cc("失敗", 'r') : cc("完成", 'g')) . "\n" : $title = "\r" . $c;

    if (is_numeric($c)) {
      $total = $c;
      $index = -1;
    }

    $present = $total ? ceil(($index + 1) * 100) / $total : 100;
    $present = $present <= 100 ? $present >= 0 ? $present : 0 : 100;

    return $title . cc('(' . number_format(++$index) . '/' . number_format($total) . ')', 'w0') . cc(' ─ ', 'N') . sprintf('% 3d%%', $present);
  }
}

if (!function_exists('main')) {
  function main($cho = null, array $params = []) {
    $menu = function($cho = null) {

      $infos = [
        '【使用說明】' => [
          '目前版本 ' . cc(VERSION, 'y'),
          ctrlC(),
        ]
      ];

      $items = [
        '1' => ['初始專案環境', 'Init Project Environment'],
        '2' => ['新增檔案', 'Create Migration or Model'],
        '3' => ['執行 Migration', 'Migration Update'],
        '4' => ['清除檔案目錄', 'Clean Cache'],
        '5' => ['部署 API Doc', 'Update API Doc'],
        '6' => ['部署專案', 'Deploy Project'],
      ];
      NEW_VERSION && $items['7'] = ['更新 Maple', 'Update Maple', '！'];
      $items['q'] = ['離開程式', 'Quit Maple'];

      $items = [
        ['title' => '【功能選項】',
         'items' => $items
        ]
      ];

      return menu($infos, $items, $cho);
    };
    
    switch ($cho = $cho ? $cho : $menu($cho)) {
      case '1':
        define('ENVIRONMENT', 'init');
        index();
        mainCho1(array_shift($params));
        break;
      
      case '2':
        index();
        mainCho2(array_shift($params));
        break;
      
      case '3':
        index();
        mainCho3(array_shift($params));
        break;
      
      case '4':
        index();
        mainCho4(array_shift($params));
        break;
      
      case '5':
        index();
        mainCho5(array_shift($params));
        break;
      
      case '6':
        index();
        mainCho6(array_shift($params));
        break;
      
      case '7':
        define('ENVIRONMENT', 'init');
        index();
        mainCho7(array_shift($params));
        break;
      
      default:
        $menu('q');
        quit();
        break;
    }
  }
}

if (!function_exists('mainCho1')) {
  function mainCho1($cho = null) {
    $menu = function($cho = null) {
      $infos = [
        '【初始環境】' => [
          '依選項初始專案',
          '建立 ' . cc('env.php', 'W') . ' 檔案',
          '建立 ' . cc('log', 'W') . '、' . cc('cache', 'W') . '、' . cc('storage', 'W') . '、' . cc('session', 'W') . '、' . cc('tmp', 'W') . '、' . cc('asset', 'W') . ' 目錄',
          ctrlC(),
        ],
      ];
      $items = [
        ['title' => '【環境選項】',
         'items' => [
            '1' => ['開發環境', 'development'],
            '2' => ['測試環境', 'testing'],
            '3' => ['正式環境', 'production'],
            'q' => ['離開程式', 'Quit Maple'],
          ]
        ]
      ];

      return menu($infos, $items, $cho);
    };

    switch ($cho = $cho ? $cho : $menu($cho)) {
      case '1':
      case '2':
      case '3':
        $menu($cho);
        init($cho);
        break;
      
      default:
        $menu('q');
        quit();
        break;
    }
  }
}

if (!function_exists('mainCho2')) {
  function mainCho2($cho = null) {
    $menu = function($cho = null) {
      $infos = [
        '【新增檔案】' => [
          '新增 Model 或 Migration 檔案',
          ctrlC(),
        ],
      ];
      $items = [
        ['title' => '【檔案選項】',
         'items' => [
            '1' => ['新增 Migration', 'Create Migration'],
            '2' => ['新增 Model', 'Create Model'],
            'q' => ['離開程式', 'Quit Maple'],
          ]
        ]
      ];

      return menu($infos, $items, $cho);
    };

    switch ($cho = $cho ? $cho : $menu($cho)) {
      case '1':
        Load::sysLib('Migration.php') || exit("\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(' 警告！ ', 'Y', 'r') . cc('Migration 初始化失敗。' . sr(' ', CLI_LEN - 30), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n\n");
        create1($menu);
        break;

      case '2':
        create2($menu);
        break;
      
      default:
        $menu('q');
        quit();
        break;
    }
  }
}

if (!function_exists('mainCho3')) {
  function mainCho3($cho = null) {
    Load::sysLib('Migration.php') || exit("\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(' 警告！ ', 'Y', 'r') . cc('Migration 初始化失敗！' . sr(' ', CLI_LEN - 30), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n\n");
    Migration::files(true) || exit("\n " . cc('◎', 'G') . " 目前沒有任何 Migration！\n\n");

    $menu = function($cho = null) {
      $infos = [
        '【Migration】' => [
          '更新 Migration 檔案',
          '更新至最新版或更新至指定版號',
          ctrlC(),
        ],
        '【版本列表】' => function () {
          $now   = Migration::nowVersion();
          $files = Migration::files(true);
          
          $items = [];
          foreach ($files as $v => $f) {
            $at = Migration::get($f);
            $at = $at['at'];
            $f = preg_replace('/^\d{3}-/', '', basename($f, '.php'));
            array_push($items, $now == $v ? '  ' . cc('➜', 'y') . '' . cc(sprintf('%3s.', $v), 'Y') . ' ' . cc(sprintf('%-53s', $f), 'Y') . cc($at, 'y') : ' ' . '  ' . sprintf('%3s.', $v) . ' ' . sprintf('%-53s', $f) . cc($at, 'w0'));
          }
          return $items;
        },
      ];
      $items = [
        ['title' => '【功能選項】',
         'items' => [
            '1' => ['更新至最新版', 'Create Migration'],
            '2' => ['輸入更新版號', 'Create Model'],
            'q' => ['離開程式', 'Quit Maple'],
          ]
        ]
      ];

      return menu($infos, $items, $cho);
    };

    switch ($cho = $cho ? $cho : $menu($cho)) {
      case 'ori':
        migration1(0, !DEPLOY, $menu);
        break;

      case 'new':
      case '1':
        migration1(null, !DEPLOY, $menu);
        break;

      case '2':
        migration2($menu);
        break;
      
      default:
        $menu('q');
        quit();
        break;
    }
  }
}

if (!function_exists('mainCho4')) {
  function mainCho4($cho = null) {
    Load::sysFunc('dir.php') || exit("\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'N', 'r') . "\n" . cc(' 警告！ ', 'Y', 'r') . cc('Clean 初始化失敗！' . sr(' ', CLI_LEN - 26), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'N', 'r') . "\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n\n");

    $menu = function($cho = null) {
      $infos = [
        '【清除暫存】' => [
          '清除專案中暫存目錄',
          '可清除的目錄有 ' . cc('Cache', 'w2') . '、' . cc('Tmp', 'w2') . '、' . cc('Session', 'w2') . ' 三種',
          ctrlC(),
        ],
      ];
      $items = [
        ['title' => '【清除選項】',
         'items' => [
            '1' => ['清除全部目錄', 'Clean All Dirs'],
            '2' => ['清除 Cache 目錄', 'Clean Cache Dir'],
            '3' => ['清除 Tmp 目錄', 'Clean Tmp Dir'],
            '4' => ['清除 Session 目錄', 'Clean Session Dir'],
            'q' => ['離開程式', 'Quit Maple'],
          ]
        ]
      ];

      return menu($infos, $items, $cho);
    };

    switch ($cho) {
      case 'all': $cho = '1'; break;
      case 'cache': $cho = '2'; break;
      case 'tmp': $cho = '3'; break;
      case 'session': $cho = '4'; break;
      default: $cho = 'q'; break;
    }

    switch ($cho = $cho ? $cho : $menu($cho)) {
      case '1':
      case '2':
      case '3':
      case '4':
        DEPLOY || $menu($cho);
        clean($cho, !DEPLOY);
        break;
      
      default:
        $menu('q');
        quit();
        break;
    }
  }
}

if (!function_exists('mainCho5')) {
  function mainCho5($cho = null) {
    $_dirs = [
      [
        'path' => PATH_DOC,
        'formats' => [],
        'recursive' => false,
        'hidden' => false,
        'includes' => ['index.html', 'api_data.js', 'api_data.json', 'api_project.js', 'api_project.json', 'apidoc.json']
      ]
    ];

    $localFilesFunc = function(array $dirs = [], $title) {
      echo progress($title) . cc('… ', 'w0');

      Load::sysLib('Minify.php');

      $mergeArrRec = function($fs, &$rfs, $p = null) use (&$mergeArrRec) {
        if (!($fs && is_array($fs)))
          return false;

        foreach ($fs as $k => $f)
          if (is_array($f))
            $k . $mergeArrRec($f, $rfs, ($p ? rtrim($p, DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR : '') . $k);
          else
            array_push($rfs, ($p ? rtrim($p, DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR : '') . $f);
      };

      $mapDir = function($sDir, $dDir = 0, $hidden = false, array $formats = [], array $includes = []) use (&$mapDir) {
        if ($fp = @opendir($sDir)) {
          $fs = [];
          $ndDir  = $dDir - 1;
          $sDir = rtrim($sDir, DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR;

          while (false !== ($f = readdir ($fp))) {
            if (trim($f, '.') == '' || (($hidden === false) && ($f[0] === '.')) || is_link($f) || $f == 'cmd')
              continue;
            if (($dDir < 1 || $ndDir > 0) && @is_dir($sDir . $f))
              $fs[$f] = $mapDir($sDir . $f . DIRECTORY_SEPARATOR, $ndDir, $hidden, $formats, $includes);
            else if (($includes && in_array(pathinfo($f, PATHINFO_BASENAME), $includes)) || ($formats && in_array(pathinfo($f, PATHINFO_EXTENSION), $formats)))
              array_push($fs, $f);
            else;
          }
          closedir($fp);

          return $fs;
        }
        return false;
      };

      $files = array_filter(arrayFlatten(array_map(function($dir) use ($mergeArrRec, $mapDir) {
        $files = [];
        $mergeArrRec($mapDir($dir['path'], $dir['recursive'] ? 0 : 1, $dir['hidden'], $dir['formats'], $dir['includes']), $files, $dir['path']);
        return $files;
      }, $dirs)), 'filesize');

      echo progress(count($files));

      unset($mergeArrRec, $mapDir);
      $files = array_map(function($file) {
        $format = pathinfo($file, PATHINFO_EXTENSION);
        $content = fileRead($file);

        if (config('apiDoc', 'minify')) {
          $bom = pack('H*','EFBBBF');

          switch ($format) {
            case 'html': $content = preg_replace("/^$bom/", '', Minify::html($content)); break;
            case 'css': $content = preg_replace("/^$bom/", '', Minify::css($content)); break;
            case 'js': $content = preg_replace("/^$bom/", '', Minify::js($content)); break;
            // case 'json': $content = preg_replace("/^$bom/", '', Minify::json($content)); break;
          }
        }
        
        $newPath = PATH_TMP . md5(uniqid(mt_rand(), true)) . ($format ? '.' . $format : '');
        fileWrite($newPath, $content, 'wb');
        unset($content);

        echo progress();

        return [
          'name' => trim(trim(config('apiDoc', 'folder'), '/') . '/' . preg_replace('/^(' . preg_replace('/\//', '\/', PATH_DOC) . ')/', '', $file), '/'),
          'hash' => md5_file($newPath),
          'path' => $newPath,
        ];
      }, $files);

      echo progress('');
      return $files;
    };

    $s3FilesFunc = function($title, &$s3) {
      echo progress($title) . cc('… ', 'w0');
      Load::sysLib('S3.php');

      $s3 = new S3(config('apiDoc', 'access'), config('apiDoc', 'secret'));
      config('apiDoc', 'bucket') || exit("\r" . $title . cc(' ─ ', 'N') . cc("失敗", 'r') . cc(' ─ ', 'N') . cc('尚未設定 Bucket', 'W') . "\n" . sr(' ', 5) . cc(" ◎ ", 'p2') . '請設定 ' . cc('apiDoc', 'w2') . ' config 的 ' . cc('Bucket', 'w2') . "\n\n");
      $s3->test() || exit("\r" . $title . cc(' ─ ', 'N') . cc("失敗", 'r') . cc(' ─ ', 'N') . cc('S3 測試失敗', 'W') . "\n" . sr(' ', 5) . cc(" ◎ ", 'p2') . (config('apiDoc', 'access') ? config('apiDoc', 'secret') ? ('請設定確定 ' . cc('Access Key', 'w2') . ' 與 ' . cc('Secret key', 'w2') . ' 的 ' . cc('apiDoc', 'w2') . ' ' . cc('Config', 'w2') . '是否有誤') : ('請設定 ' . cc('apiDoc', 'w2') . ' config 的 ' . cc('Access key', 'w2')) : ('請設定 ' . cc('apiDoc', 'w2') . ' config 的 ' . cc('Secret key', 'w2'))) . "\n\n");
      
      $files = $s3->bucket(config('apiDoc', 'bucket'), config('apiDoc', 'folder'));
      $files !== false || exit("\r" . $title . cc(' ─ ', 'N') . cc("失敗", 'r') . "\n" . sr(' ', 5) . cc(" ◎ ", 'p2') . '請確認 ' . cc('apiDoc', 'w2') . ' config 的資訊是否有誤！' . "\n\n");
      echo progress(count($files));
      
      $files = array_values(array_map(function($file) {
        unset($file['time'], $file['size']);
        echo progress();
        return $file;
      }, $files));
      echo progress('');

      return $files;
    };

    $filterLocalFilesFunc = function($title, array $localFiles, array $s3Files) {
      echo progress($title) . cc('… ', 'w0');
      echo progress(count($localFiles));

      $files = array_filter($localFiles, function($localFile) use ($s3Files) {
        echo progress();

        foreach ($s3Files as $s3File)
          if ($s3File['name'] == $localFile['name'] && $s3File['hash'] == $localFile['hash'])
            return false;

        return true;
      });

      echo progress('');
      return $files;
    };

    $uploadFilesFunc = function($title, $uploadFiles, $s3) {
      echo progress($title) . cc('… ', 'w0');
      echo progress(count($uploadFiles));

      $files = array_filter(array_map(function($uploadFile) use ($s3) {
        echo progress();
        return !$s3->putObject($uploadFile['path'], config('apiDoc', 'bucket'), $uploadFile['name']) ? sr(' ', 5) . cc(" ◎ ", 'p2') . '檔案 ' . cc(ltrim(preg_replace('/^(' . preg_replace('/\//', '\/', config('apiDoc', 'folder')) . ')/', '', $uploadFile['name']), '/'), 'W') . cc(' ➜ ', 'w0') . '' . cc($uploadFile['name'], 'w2') . ' 上傳失敗' : '';
      }, $uploadFiles));

      if (!$files) {
        echo progress('');
        return $files;
      }

      echo progress('_');
      exit(implode("\n", $files) . "\n\n");
    };

    $filterS3FilesFunc = function($title, array $s3Files, array $localFiles) {
      echo progress($title) . cc('… ', 'w0');
      echo progress(count($s3Files));

      $files = array_filter($s3Files, function($s3File) use ($localFiles) {
        echo progress();

        foreach ($localFiles as $localFile)
          if ($localFile['name'] == $s3File['name'])
            return false;

        return true;
      });

      echo progress('');
      return $files;
    };

    $deleteFilesFunc = function($title, array $deleteFiles, $s3) {
      echo progress($title) . cc('… ', 'w0');
      echo progress(count($deleteFiles));

      $files = array_filter(array_map(function($deleteFile) use ($s3) {
        echo progress();
        return !$s3->deleteObject(config('apiDoc', 'bucket'), $deleteFile['name']) ? sr(' ', 5) . cc(" ◎ ", 'p2') . '檔案 ' . cc($deleteFile['name'], 'w2') . ' 刪除失敗' : '';
      }, $deleteFiles));

      if (!$files) {
        echo progress('');
        return $files;
      }

      echo progress('_');
      exit(implode("\n", $files) . "\n\n");
    };

    $deleteTmpFilesFunc = function($title, array $localFiles) {
      echo progress($title) . cc('… ', 'w0');
      echo progress(count($localFiles));

      $files = array_filter(array_map(function($localFile) {
        echo progress();
        echo !@unlink($localFile['path']) ? sr(' ', 5) . cc(" ◎ ", 'p2') . '檔案 ' . cc(ltrim(preg_replace('/^(' . preg_replace('/\//', '\/', PATH) . ')/', '', $localFile['path']), '/'), 'w2') . ' 刪除失敗' : '';
      }, $localFiles));

      if (!$files) {
        echo progress('');
        return $files;
      }

      echo progress('_');
      exit(implode("\n", $files) . "\n\n");
    };

    system('clear');
    echo Logo::show();
    echo "\n";
    echo cc(' 【部署 API Doc】', 'R') . "\n";
    echo sr(' ', 4) . cc('➤ ', 'c2') . '注意喔，過程中請勿隨意結束！' . "\n";
    echo sr(' ', 4) . cc('➤ ', 'c2') . '坐好囉，我們即將開始幫您部署！' . "\n";

    echo "\n";
    echo cc(' 【檔案處理】', 'y') . "\n";
    $localFiles = $localFilesFunc($_dirs, sr(' ', 4) . cc('➤ ', 'c2') . "整理本機內檔案");
    unset($localFilesFunc);
    
    $s3Files = $s3FilesFunc(sr(' ', 4) . cc('➤ ', 'c2') . "取得 S3 上檔案", $s3);
    unset($s3FilesFunc);
    

    echo "\n";
    echo cc(' 【上傳檔案】', 'y') . "\n";
    $uploadFiles = $filterLocalFilesFunc(sr(' ', 4) . cc('➤ ', 'c2') . "過濾上傳的檔案", $localFiles, $s3Files);
    unset($filterLocalFilesFunc);
    
    $uploadFilesFunc(sr(' ', 4) . cc('➤ ', 'c2') . "上傳檔案至 S3 ", $uploadFiles, $s3);
    unset($uploadFilesFunc);


    echo "\n";
    echo cc(' 【刪除檔案】', 'y') . "\n";
    $deleteFiles = $filterS3FilesFunc(sr(' ', 4) . cc('➤ ', 'c2') . "過濾刪除的檔案", $s3Files, $localFiles);
    unset($filterS3FilesFunc);
    
    $deleteFilesFunc(sr(' ', 4) . cc('➤ ', 'c2') . "刪除 S3 的檔案", $deleteFiles, $s3);
    unset($deleteFilesFunc);
    
    $deleteTmpFilesFunc(sr(' ', 4) . cc('➤ ', 'c2') . "刪除暫存的檔案", $localFiles);
    unset($deleteTmpFilesFunc);
    

    echo "\n";
    echo cc(' 【更新完成】', 'R') . "\n";
    echo sr(' ', 4) . cc('➤ ', 'c2') . '已經更新成功囉！' . "\n";
    echo sr(' ', 4) . cc('➤ ', 'c2') . '目前已經是最新版囉！趕緊打開頁面看看吧！' . "\n";

    echo "\n";
  }
}

if (!function_exists('mainCho6')) {
  function mainCho6($cho = null) {
    $deploy = array_filter(is_array($deploy = config('deploy')) ? $deploy : [], function($t) { return isset($t['name'], $t['host'], $t['user'], $t['port'], $t['stage'], $t['path']); });
    
    $items = [];
    foreach ($deploy as $i => $dep)
      $items[$i + 1] = ['部署' . $dep['name'], 'Deploy ' . $dep['stage'], $dep['stage']];
    
    $items || exit("\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(' 警告！ ', 'Y', 'r') . cc('請先設定 deploy 的 config 吧！' . sr(' ', CLI_LEN - 38), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n\n");

    $items['q'] = ['離開程式', 'Quit Maple'];
    
    $menu = function($cho = null) use ($items) {
      $infos = [
        '【部署專案】' => [
          '將專案部署至 Server，使用 Deployer SSH 至 Server 上操作更新',
          '在指定的專案目錄下使用 Git Pull 來達成更新專案',
          '並且執行 Migration 與 Clean',
          ctrlC(),
        ],
      ];

      $items = [
        ['title' => '【檔案選項】',
         'items' => array_map(function($t) { return [$t[0], $t[1]]; }, $items)
        ]
      ];

      return menu($infos, $items, $cho);
    };

    switch ($cho = $cho ? $cho : $menu($cho)) {
      case 'q':
        $menu('q');
        quit();
        break;
      
      default:
        deploy($items[$cho][2]);
        break;
    }
  }
}

if (!function_exists('mainCho7')) {
  function mainCho7($cho = null) {
    if (!NEW_VERSION)
      return;

    while (true) {
      system('clear');
      echo Logo::show();
      echo "\n\n " . cc('➜', 'R') . ' 確定要更新至版本 ' . cc(NEW_VERSION, 'w2') . '：' . cc('[y：沒錯, n：不要]', 'w0') . '：';
      $yn = strtolower(trim(fgets(STDIN)));

      if ($yn == 'n')
        return main();

      if ($yn == 'y')
        break;
    }

    system('clear');
    echo Logo::show();
    echo "\n" . cc(' 【更新 Maple】', 'R') . "\n";
    echo sr(' ', 4) . cc('➤ ', 'c2') . '注意喔，過程中請勿隨意結束！' . "\n";
    echo sr(' ', 4) . cc('➤ ', 'c2') . '坐好囉，我們即將開始幫您更新！' . "\n";

    echo "\n" . cc(' 【執行更新】', 'y') . "\n";
    
    $title = "\r" . sr(" ", 4) . cc("➤ ", "c2") . "正在取得最新的 Maple 指令";
    echo $title . cc("… ", "w0");
    $content = @file_get_contents('https://comdan66.github.io/Maple/maple?=' . time());
    $path = (file_exists(PATH_TMP) ? PATH_TMP : PATH) . 'mapel_' . md5(uniqid(mt_rand(), true));
    fileWrite($path, $content, 'w+b') || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "無法寫入檔案" . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "請檢查 tmp 目錄的權限配置" . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "目前版本依然是 " . cc(VERSION, 'w2') . "\n" . "\n");
    echo $title . cc(" ─ ", "N") . cc("完成", "g") . "\n";

    $title = "\r" . sr(" ", 4) . cc("➤ ", "c2") . "搬移 Maple 指令至 " . cc('/usr/local/bin/', 'w2');
    echo $title . cc("… ", "w0");
    @rename($path, '/usr/local/bin/maple') || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "無法搬移檔案" . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "請檢查 /usr/local/bin/ 目錄的權限配置" . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "目前版本依然是 " . cc(VERSION, 'w2') . "\n" . "\n");
    echo $title . cc(" ─ ", "N") . cc("完成", "g") . "\n";

    $title = "\r" . sr(" ", 4) . cc("➤ ", "c2") . "變更 Maple 權限";
    echo $title . cc("… ", "w0");
    passthru('chmod +x /usr/local/bin/maple');
    fileperms('/usr/local/bin/maple') == '33261' || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "無法變更權限" . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "請檢查 /usr/local/bin/maple 目錄的權限配置" . "\n" . "\n");
    echo $title . cc(" ─ ", "N") . cc("完成", "g") . "\n";

    echo "\n";
    echo cc(' 【更新完成】', 'R') . "\n";
    echo sr(' ', 4) . cc('➤ ', 'c2') . '已經更新成功囉！' . "\n";
    echo sr(' ', 4) . cc('➤ ', 'c2') . '目前已經是最新版囉！' . "\n";
    echo sr(' ', 4) . cc('➤ ', 'c2') . '重新開啟瀏覽後就可以使用最新版的 Maple 囉！' . "\n";
    echo "\n";
  }
}

if (!function_exists('init')) {
  function init($cho) {
    function dirsMaker ($dirs, $path = '') {
      foreach ($dirs as $dir => $files) {
        echo "\n";
        $title = "\r" . sr(" ", 4) . cc("➤ ", "c2") . "建立 " . cc($path . $dir, 'W') . " 目錄";
        echo $title . cc("… ", "w0");

        is_file($path . $dir) && exit($title . cc(" ─ ", "N") . cc("失敗", "r") . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "存在一樣檔名的檔案！" . "\n" . "\n");

        is_dir($path . $dir) || umaskMkdir($path . $dir, 0777, true) || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "產生資料夾失敗！" . "\n" . "\n");

        echo $title . cc(" ─ ", "N") . cc("完成", "g") . "\n";


        foreach ($files as $name => $content) {
          if (is_callable($content)) {
            $title = "\r" . sr(" ", 6) . cc("➜ ", "p2") . "建立 " . cc($name, 'w2') . " 捷徑";
            echo $title . cc("… ", "w0");
            $content($path . $dir . DIRECTORY_SEPARATOR) || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "建立捷徑失敗！" . "\n" . "\n");
            echo $title . cc(" ─ ", "N") . cc("完成", "g") . "\n";
          } else if (is_string($content)) {
            $title = "\r" . sr(" ", 6) . cc("➜ ", "p2") . "建立 " . cc($name, 'W') . " 檔案";
            echo $title . cc("… ", "w0");
            fileWrite($path . $dir . DIRECTORY_SEPARATOR . $name, $content, 'w+b') || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "寫入檔案失敗！" . "\n" . "\n");
            echo $title . cc(" ─ ", "N") . cc("完成", "g") . "\n";
          } else if (is_array($content)) {
            dirsMaker([$name => $content], $dir . DIRECTORY_SEPARATOR);
          }
        }
      }
    };

    system('clear');
    echo Logo::show();
    echo "\n";
    echo cc(' 【初始專案】', 'R') . "\n";
    echo sr(' ', 4) . cc('➤ ', 'c2') . '注意喔，過程中請勿隨意結束！' . "\n";
    echo sr(' ', 4) . cc('➤ ', 'c2') . '坐好囉，我們即將開始幫您建立初始結構！' . "\n";
    
    $index = "<!DOCTYPE html><html lang=\"tw\"><head><meta http-equiv=\"Content-Language\" content=\"zh-tw\" /><meta http-equiv=\"Content-type\" content=\"text/html; charset=utf-8\" /><meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui\" /><title>403 禁止訪問 | Maple</title><style type=\"text/css\">*,*:after,*:before{vertical-align:top;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;-moz-osx-font-smoothing:antialiased;-webkit-font-smoothing:antialiased;-moz-font-smoothing:antialiased;-ms-font-smoothing:antialiased;-o-font-smoothing:antialiased}*::-moz-selection,*:after::-moz-selection,*:before::-moz-selection{color:#fff;background-color:#96c8ff}*::selection,*:after::selection,*:before::selection{color:#fff;background-color:#96c8ff}html{height:100%}html body{font-family:Arial, \"微軟正黑體\", \"Microsoft JhengHei\", -apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,\"Helvetica Neue\",Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\",\"Segoe UI Symbol\";height:auto;text-align:center;margin:0;padding:0;font-size:medium;font-weight:normal;color:#555;background-color:#fff;background-color:#f9fafe;position:relative;display:inline-block;width:100%;min-height:100%}.container{display:inline-block}.container .image{margin:250px auto 0 auto;width:180px;height:65px}@media screen and (max-width: 475px) and (min-width: 0){.container .image{margin:120px auto 0 auto;} }.container .image img{width:100%;height:100%}.container .text{display:block;font-size:18px;color:#b5bcbc;margin-top:30px}.container .text a{display: inline-block; color: #76c7d2;}.container .text + .text{margin-top: 8px;}.container .footer{position:fixed;display:block;bottom:100px;width:100%;left:0;text-align: center;}.container .footer>*{display:inline-block;height:40px}.container .footer .logo{width:40px;height:40px}.container .footer .logo img{width:100%}.container .footer span{font-size:18px;font-weight:bold;line-height:40px;color:#44c3ce;margin-left:10px}</style></head><body lang=\"zh-tw\"><div class=\"container\"><div class=\"image\"><img src=\"/asset/img/oops.png\"></div><span class=\"text\">您無權查看該網頁！</span><div class=\"footer\"><span>Maple<span></div></div></body></html>";
    
    $dirs = [
      '.' => [
        'env.php' => "<?php defined('MAPLE') || exit('此檔案不允許讀取！');\n\n\n/* ------------------------------------------------------\n *  定義環境常數\n * ------------------------------------------------------ */\n\n" . ($cho == '1' ? '' : '// ') . "define('ENVIRONMENT', 'development');" . "\n" . ($cho == '2' ? '' : '// ') . "define('ENVIRONMENT', 'testing');" . "\n" . ($cho == '3' ? '' : '// ') . "define('ENVIRONMENT', 'production');" . "\n" . "\n\nswitch (ENVIRONMENT) {\n  case 'development':\n  case 'testing':\n    ini_set('display_errors', 1);\n    error_reporting(-1);\n    break;\n\n  case 'production':\n    ini_set('display_errors', 0);\n    error_reporting(E_ALL & ~E_NOTICE & ~E_DEPRECATED & ~E_STRICT & ~E_USER_NOTICE & ~E_USER_DEPRECATED);\n    break;\n\n  default:\n    new GG('「環境變數(ENVIRONMENT)」設定錯誤！', 503);\n    break;\n}\n",
      ],
      
      '.release' => ['index.html' => $index],
      'log' => ['index.html' => $index],
      'cache' => ['index.html' => $index],
      'storage' => ['index.html' => $index],
      'session' => ['index.html' => $index],
      'tmp' => ['index.html' => $index],
      'asset' => ['index.html' => $index],

      'doc' => [
        '_' => function($path) {
          $name = $path . '_';
          return file_exists($name) && !@unlink($name) ? false : (@symlink('../', $name) && file_exists($name));
        },
        'apidoc.json' => "{\n  \"name\": \"Maple\",\n  \"version\": \"0.0.0\",\n  \"description\": \"API 文件\"\n}",
        'gulpfile.js' => "var gulp = require('gulp'),\n    livereload = require('gulp-livereload'),\n    chokidar   = require('chokidar'),\n    apidoc = require('gulp-apidoc'),\n    directoryExists = require('directory-exists'),\n    gutil = require('gulp-util'),\n    colors = gutil.colors;\n\ngulp.task('api', function() {\n  directoryExists('./_/').then(function(r) {\n    if (!r) {\n      console.error(\"\\n\");\n      console.error(colors.red(' ※ 錯誤！') + '請先執行 ' + colors.bold(colors.white('ln -s ../ _')) + ' 指令建立捷徑，再執行 ' + colors.bold(colors.white('gulp api')) + '！');\n      console.error(\"                  \" + (colors.yellow('^^^^^^^^^^^')) + \"                      \" + (colors.yellow('^^^^^^^^')) + \"\\n\");\n    } else {\n      livereload.listen(null, {\n        silent: true\n      });\n      var watcherReload = chokidar.watch(['./_/app/controller/api/*.+(php)'], {\n        ignored: /(^|[\/\\\\])\../,\n        persistent: true\n      });\n      watcherReload.on('change', runApidoc).on('add', runApidoc).on('unlink', runApidoc);\n    }\n  });\n});\n\nfunction runApidoc(path) {\n  apidoc({\n    src: './_/app/controller/api/',\n    dest: './',\n    config: './',\n    includeFilters: [ \".*\\.php$\" ],\n     template: 'template'\n  },function() {\n    gulp.run('reload');\n  });\n}\n\ngulp.task('reload', function() {\n  livereload.changed();\n  console.info('\\n ' + colors.red('➤') + ' 瀏覽器重新整理！\\n');\n});",
        'package.json' => "{\n  \"name\": \"Maple\",\n  \"version\": \"4.3.3\",\n  \"description\": \"Maple PHP 框架！\",\n  \"author\": \"OA Wu\",\n  \"email\": \"comdan66@gmail\",\n  \"devDependencies\": {\n    \"del\": \"^0.1.0\",\n    \"gulp\": \"^3.8.9\",\n    \"gulp-livereload\": \"^2.1.1\",\n    \"chokidar\": \"^1.6.1\",\n    \"gulp-apidoc\": \"^0.2.7\",\n    \"directory-exists\": \"^2.0.0\",\n    \"gulp-util\": \"^3.0.8\"\n  }\n}",
      ],
      'doc/template' => [
        'index.html' => '<!DOCTYPE html>' . "\n" . '<html lang="tw">' . "\n" . '  <head>' . "\n" . '    <meta http-equiv="Content-Language" content="zh-tw" />' . "\n" . '    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />' . "\n" . "\n" . '    <title></title>' . "\n" . "\n" . '    <style type="text/css">*,*:after,*:before{vertical-align:top;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;-moz-osx-font-smoothing:antialiased;-webkit-font-smoothing:antialiased;-moz-font-smoothing:antialiased;-ms-font-smoothing:antialiased;-o-font-smoothing:antialiased}*::-moz-selection,*:after::-moz-selection,*:before::-moz-selection{color:#fff;background-color:#96c8ff}*::selection,*:after::selection,*:before::selection{color:#fff;background-color:#96c8ff}html{min-height:100%}html body{position:relative;display:inline-block;width:100%;min-height:100%;margin:0;padding:0;color:#5a5a5a;text-align:center;font-size:medium;font-family:Roboto, RobotoDraft, Helvetica, Arial, sans-serif, "微軟正黑體", "Microsoft JhengHei";-moz-osx-font-smoothing:antialiased;-webkit-font-smoothing:antialiased;-moz-font-smoothing:antialiased;-ms-font-smoothing:antialiased;-o-font-smoothing:antialiased}#load{position:fixed;left:0;top:0;right:0;bottom:0;display:inline-block;width:100%;height:100%;z-index:99999;background-color:#005792;filter:progid:DXImageTransform.Microsoft.Alpha(enabled=false);opacity:1;-moz-transition:opacity .3s;-o-transition:opacity .3s;-webkit-transition:opacity .3s;transition:opacity .3s}#load.hide{filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#load>div{position:absolute;top:calc(50% - 175px);height:350px;left:calc(50% - 250px);width:500px;display:inline-block;color:#fff}#load>div h1{text-shadow:0 0 3px rgba(110,22,11,0.3);text-shadow:0 0 3px 1px rgba(110,22,11,0.3)}#load>div>p{display:block;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=85);opacity:.85;*zoom:1}#load>div>p:after{display:table;content:"";line-height:0;clear:both}#load>div>span{display:block;margin-top:45px;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=55);opacity:.55;font-size:13px}#load>div>div{display:inline-block;margin:0 auto;margin-top:35px;*zoom:1}#load>div>div:after{display:table;content:"";line-height:0;clear:both}#load>div>div i{float:left;display:inline-block;width:10px;height:10px;-moz-border-radius:50%;-webkit-border-radius:50%;border-radius:50%;background-color:rgba(255,255,255,0.6);-moz-animation:l 1.4s infinite ease-in-out both;-webkit-animation:l 1.4s infinite ease-in-out both;animation:l 1.4s infinite ease-in-out both;margin:2px}#load>div>div i:nth-child(2){-moz-animation-delay:.16s;-webkit-animation-delay:.16s;animation-delay:.16s}#load>div>div i:nth-child(3){-moz-animation-delay:.32s;-webkit-animation-delay:.32s;animation-delay:.32s}@-moz-keyframes l{0%, 80%, 100%{-moz-transform:scale(0, 0);transform:scale(0, 0)}40%{-moz-transform:scale(1, 1);transform:scale(1, 1)}}@-webkit-keyframes l{0%, 80%, 100%{-webkit-transform:scale(0, 0);transform:scale(0, 0)}40%{-webkit-transform:scale(1, 1);transform:scale(1, 1)}}@keyframes l{0%, 80%, 100%{-moz-transform:scale(0, 0);-ms-transform:scale(0, 0);-webkit-transform:scale(0, 0);transform:scale(0, 0)}40%{-moz-transform:scale(1, 1);-ms-transform:scale(1, 1);-webkit-transform:scale(1, 1);transform:scale(1, 1)}}#menu{position:fixed;left:0;top:0;display:inline-block;padding-bottom:16px;width:320px;height:100%;border-right:1px solid #dcdcdc;z-index:10;overflow:hidden;background-color:#f5f5f5;overflow-y:auto;-moz-transition:background-color .3s;-o-transition:background-color .3s;-webkit-transition:background-color .3s;transition:background-color .3s;-webkit-overflow-scrolling:touch}#menu:empty:before{content:"讀取中..";display:inline-block;width:100%;height:48px;line-height:48px;text-align:center;font-size:18px;font-weight:bold;color:#c8c8c8}#menu.focus{background-color:#ebebeb}#menu[data-tip]:not([data-tip=""]):empty:before{content:attr(data-tip)}#menu>*{position:relative;display:inline-block;width:100%}#search{padding:12px;background-color:rgba(200,200,200,0.2);border-bottom:1px solid #c8c8c8}#search input{display:inline-block;height:30px;line-height:27px;border:1px solid #c8c8c8;font-size:16px;padding:0 4px;color:#787878;-moz-border-radius:2px;-webkit-border-radius:2px;border-radius:2px;-moz-transition:box-shadow .3s,border-color .3s;-o-transition:box-shadow .3s,border-color .3s;-webkit-transition:box-shadow .3s,border-color .3s;transition:box-shadow .3s,border-color .3s;width:100%}#search input:-moz-placeholder{font-size:14px;font-weight:normal;color:#afafaf}#search input::-moz-placeholder{font-size:14px;font-weight:normal;color:#afafaf}#search input:-ms-input-placeholder{font-size:14px;font-weight:normal;color:#afafaf}#search input::-webkit-input-placeholder{font-size:14px;font-weight:normal;color:#afafaf}#search input:focus{outline:0;border:1px solid #64afeb;-moz-box-shadow:0 0 8px rgba(100,175,235,0.6);-webkit-box-shadow:0 0 8px rgba(100,175,235,0.6);box-shadow:0 0 8px rgba(100,175,235,0.6)}#search input[readonly]{cursor:not-allowed;background-color:#fafafa;border:1px solid #e1e1e1}#search input[readonly]:-moz-placeholder{color:#c8c8c8}#search input[readonly]::-moz-placeholder{color:#c8c8c8}#search input[readonly]:-ms-input-placeholder{color:#c8c8c8}#search input[readonly]::-webkit-input-placeholder{color:#c8c8c8}#search input[readonly]:focus{border:1px solid #e1e1e1;-moz-box-shadow:none;-webkit-box-shadow:none;box-shadow:none}#search input[type="file"]{font-size:14px;padding:4px;line-height:0;width:auto}#search button{position:absolute;right:13px;top:13px;display:inline-block;width:28px;height:28px;border:0;cursor:pointer;font-size:14px;color:#646464;-moz-transition:color .3s;-o-transition:color .3s;-webkit-transition:color .3s;transition:color .3s}#search button:after{content:"";position:absolute;left:0;top:4px;display:inline-block;width:1px;height:calc(100% - 4px * 2);background-color:rgba(0,0,0,0.2)}#search button:hover{color:#505050}#search button:focus{outline:0}#apis{padding-bottom:40px}#apis:empty:before{content:"讀取中..";display:inline-block;width:100%;height:48px;line-height:48px;text-align:center;font-size:16px;font-weight:bold;color:#c8c8c8}#apis[data-tip]:not([data-tip=""]):empty:before{content:attr(data-tip)}#apis>div{position:relative;display:inline-block;width:100%;text-align:left;padding:0;border-top:1px solid #e1e1e1;border-bottom:1px solid #e1e1e1;margin-top:44px;background-color:white}#apis>div:before,#apis>div:after{position:absolute;display:inline-block;font-size:14px}#apis>div:before{content:"其他";top:-28px;left:0;width:100%;height:28px;line-height:28px;padding-left:8px;color:#a0a0a0;font-weight:bold;text-shadow:1px 1px 1px #fff}#apis>div:after{right:4px;top:-24px;height:20px;min-width:22px;line-height:20px;padding:0 4px;text-align:center;background-color:rgba(0,0,255,0.2);color:white;background-color:#c3c3c3;font-weight:bold;-moz-transform:scale(.9, .9);-ms-transform:scale(.9, .9);-webkit-transform:scale(.9, .9);transform:scale(.9, .9);-moz-border-radius:10px;-webkit-border-radius:10px;border-radius:10px;-moz-box-shadow:inset 1px 1px 1px rgba(0,0,0,0.15),1px 1px 1px rgba(255,255,255,0.75);-webkit-box-shadow:inset 1px 1px 1px rgba(0,0,0,0.15),1px 1px 1px rgba(255,255,255,0.75);box-shadow:inset 1px 1px 1px rgba(0,0,0,0.15),1px 1px 1px rgba(255,255,255,0.75);text-shadow:1px 1px 1px rgba(0,0,0,0.3)}#apis>div[data-title]:not([data-title=""]):before{content:attr(data-title);color:#969696}#apis>div[data-cnt]:not([data-cnt="0"]):not(:empty):after{content:attr(data-cnt)}#apis>div:empty:after{position:relative;right:auto;top:auto;content:"無資料";width:100%;height:48px;line-height:48px;text-align:center;color:#c8c8c8;background-color:transparent;-moz-box-shadow:none;-webkit-box-shadow:none;box-shadow:none;text-shadow:none;-moz-border-radius:0;-webkit-border-radius:0;border-radius:0}#apis>div>a{position:relative;display:inline-block;width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;height:50px;padding-top:15px;padding-left:66px;text-decoration:none;color:#6f6f6f;-moz-transition:color .3s;-o-transition:color .3s;-webkit-transition:color .3s;transition:color .3s;background-color:white;font-size:14px;cursor:pointer}#apis>div>a:hover{color:#414141}#apis>div>a:after,#apis>div>a:before{position:absolute;display:inline-block;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}#apis>div>a:after{content:"";bottom:0;left:62px;width:calc(100% - (8px + 50px + 4px));height:22px;font-size:10px;padding-left:4px;color:#b4b4b4;border-bottom:1px solid #ebebeb}#apis>div>a:before{left:8px;top:10px;text-transform:uppercase;width:50px;height:30px;line-height:30px;font-size:10px;font-weight:normal;text-align:center;color:white;-moz-transform:scale(.85, .85);-ms-transform:scale(.85, .85);-webkit-transform:scale(.85, .85);transform:scale(.85, .85);-moz-border-radius:3px;-webkit-border-radius:3px;border-radius:3px}#apis>div>a[data-url]:not([data-url=""]){padding-top:8px}#apis>div>a[data-url]:not([data-url=""]):after{content:attr(data-url)}#apis>div>a[data-type]:not([data-type=""]):before{content:attr(data-type);background-color:#999}#apis>div>a[data-type]:not([data-type=""])[data-type="get" i]:before{content:"Get";background-color:#65b74c}#apis>div>a[data-type]:not([data-type=""])[data-type="post" i]:before{content:"Post";background-color:#6e90e8}#apis>div>a[data-type]:not([data-type=""])[data-type="put" i]:before{content:"Put";background-color:#e6be00}#apis>div>a[data-type]:not([data-type=""])[data-type="delete" i]:before{content:"Del";background-color:#ea443b}#apis>div>a:last-child:after{border-bottom:0}#apis>div>a.active{font-weight:bold;color:#323232}#apis>div>a.active:before{font-weight:bold}#apis>div>a.active:after{color:#646464;font-weight:normal}#main{position:relative;display:inline-block;width:100%;padding-left:320px;z-index:5;text-align:left}#main:empty:before,#main>div:empty:before{content:"讀取中..";display:inline-block;width:100%;height:48px;line-height:48px;text-align:center;font-size:20px;font-weight:bold;color:#c8c8c8}#main[data-tip]:not([data-tip=""]):empty:before,#main>div[data-tip]:not([data-tip=""]):empty:before{content:attr(data-tip)}#main>div{position:relative;padding:20px 32px}#main>div>*:first-child{margin-top:0}#main>div>*+*{margin-top:44px}#main>div>header,#main>div>header>*{display:inline-block;width:100%}#main>div>header>h1{width:100%;height:32px;line-height:32px;margin:0;font-size:22px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}#main>div>header>h1:before{display:inline-block;margin-right:8px}#main>div>header>h1[data-title]:not([data-title=""]):before{}#main>div>header>section:empty{display:none}#main>div>header>section>p{display:inline-block;width:100%;margin:0;color:gray;font-size:13px}#main>div .important{display:inline-block;width:100%;margin-top:30px}#main>div .important:empty{display:none}#main>div .important>*{display:inline-block;width:100%}#main>div .important>div{display:inline-block;width:100%;margin-left:0;margin-right:0;padding-left:8px;padding-top:8px;border-top:1px solid #e6e6e6;border-right:1px solid #e6e6e6;border-left:1px solid #e6e6e6;background-color:#fafafa;padding-bottom:8px}#main>div .important>div:first-child{-moz-border-radius-topleft:5px;-webkit-border-top-left-radius:5px;border-top-left-radius:5px;-moz-border-radius-topright:5px;-webkit-border-top-right-radius:5px;border-top-right-radius:5px}#main>div .important>div:last-child{border-bottom:1px solid #e6e6e6;-moz-border-radius-bottomleft:5px;-webkit-border-bottom-left-radius:5px;border-bottom-left-radius:5px;-moz-border-radius-bottomright:5px;-webkit-border-bottom-right-radius:5px;border-bottom-right-radius:5px}#main>div .important>div+div{border-top:1px dashed #e6e6e6}#main>div .important>div>*{display:inline-block;width:100%}#main>div .important>div span{height:28px;line-height:28px;font-weight:bold;color:#0b84a9}#main>div .important>div span:before{content:"！";display:inline-block;margin-right:4px;width:20px;height:20px;line-height:20px;text-align:center;font-size:14px;border:1px solid #0b84a9;background-color:white;margin-top:2px;-moz-border-radius:10px;-webkit-border-radius:10px;border-radius:10px}#main>div .important>div div{height:20px;line-height:20px;padding-left:20px;padding-right:16px;margin-top:4px;font-size:16px}#main>div .important>div div:empty{display:none}#main>div .important>div p{margin:0;line-height:20px;padding-left:20px;padding-right:16px;font-size:13px;color:#828282}#main>div .important>div p:empty{display:none}#main>div .important>div p code{display:inline-block;color:red;background-color:#ffefef;padding:0 4px;color:#be4b4b;font-weight:bold;-moz-border-radius:2px;-webkit-border-radius:2px;border-radius:2px}#main>div .url{position:relative;display:inline-block;width:100%;padding-left:70px;overflow:hidden;-moz-border-radius:3px;-webkit-border-radius:3px;border-radius:3px}#main>div .url:before{content:"get";position:absolute;left:0;top:0;display:inline-block;width:70px;height:44px;line-height:44px;text-align:center;color:white}#main>div .url:before{content:attr(data-type);text-transform:uppercase}#main>div .url[data-type]:not([data-type=""]):before{content:attr(data-type);background-color:#999}#main>div .url[data-type]:not([data-type=""])[data-type="get" i]:before{content:"Get";background-color:#65b74c}#main>div .url[data-type]:not([data-type=""])[data-type="post" i]:before{content:"Post";background-color:#6e90e8}#main>div .url[data-type]:not([data-type=""])[data-type="put" i]:before{content:"Put";background-color:#e6be00}#main>div .url[data-type]:not([data-type=""])[data-type="delete" i]:before{content:"Del";background-color:#ea443b}#main>div .url>pre{margin:0;display:inline-block;width:100%;height:44px;line-height:44px;color:white;padding:0 8px;font-size:16px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;overflow-x:auto;background-color:#272822}#main>div .format{display:inline-block;width:100%}#main>div .format .tabs{position:relative;display:inline-block;width:100%;height:44px;padding:0 8px;*zoom:1;overflow:hidden}#main>div .format .tabs:after{display:table;content:"";line-height:0;clear:both}#main>div .format .tabs:after{content:"";position:absolute;bottom:0;left:0;display:inline-block;width:100%;height:1px;z-index:2;background-color:#dedede;-moz-box-shadow:0 -1px 3px rgba(200,200,200,0.5);-webkit-box-shadow:0 -1px 3px rgba(200,200,200,0.5);box-shadow:0 -1px 3px rgba(200,200,200,0.5)}#main>div .format .tabs>*{position:relative;z-index:1;float:left;display:inline-block;padding:0 12px;height:32px;line-height:32px;border:1px solid #dcdcdc;border-bottom:0;margin-top:12px;cursor:pointer;border-right-width:0;font-size:14px;background-color:white;background-color:#fafafa;-moz-transition:margin-top .3s,height .3s,border-radius .3s;-o-transition:margin-top .3s,height .3s,border-radius .3s;-webkit-transition:margin-top .3s,height .3s,border-radius .3s;transition:margin-top .3s,height .3s,border-radius .3s}#main>div .format .tabs>*:first-child{-moz-border-radius-topleft:3px;-webkit-border-top-left-radius:3px;border-top-left-radius:3px}#main>div .format .tabs>*:last-child{-moz-border-radius-topright:3px;-webkit-border-top-right-radius:3px;border-top-right-radius:3px;border-right-width:1px}#main>div .format .tabs>*[data-cnt]:not([data-cnt="0"]):after{content:attr(data-cnt);display:inline-block;height:24px;line-height:24px;font-size:10px;color:white;margin-top:4px;margin-left:6px;padding:0 8px;text-align:center;background-color:#c8c8c8;-moz-border-radius:12px;-webkit-border-radius:12px;border-radius:12px;-moz-transform:scale(.8, .8);-ms-transform:scale(.8, .8);-webkit-transform:scale(.8, .8);transform:scale(.8, .8);-moz-transition:background-color .3s;-o-transition:background-color .3s;-webkit-transition:background-color .3s;transition:background-color .3s}#main>div .format .panels{position:relative;display:inline-block;width:100%;overflow:hidden;margin-top:8px}#main>div .format .panels>*{position:absolute;left:0;top:0;display:inline-block;width:100%;height:100%;padding:16px;-moz-transition:left .3s,opacity .3s;-o-transition:left .3s,opacity .3s;-webkit-transition:left .3s,opacity .3s;transition:left .3s,opacity .3s;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format .panels>*:nth-child(1){left:0%;position:relative;filter:progid:DXImageTransform.Microsoft.Alpha(enabled=false);opacity:1}#main>div .format .panels>*:nth-child(2){left:100%}#main>div .format .panels>*:nth-child(3){left:200%}#main>div .format .panels>*:nth-child(4){left:300%}#main>div .format .panels>*:nth-child(5){left:400%}#main>div .format .panels>*>h3{display:inline-block;width:100%;margin-top:32px}#main>div .format .panels>*>h3:first-child{margin-top:0}#main>div .format .panels>*>.sample{display:inline-block;width:100%;margin-top:0;padding:8px 16px;font-size:16px;border:0;overflow-x:auto;-moz-border-radius:3px;-webkit-border-radius:3px;border-radius:3px;background-color:#272822}#main>div .format .panels>*>.sample .pln,#main>div .format .panels>*>.sample .pun{color:white !important}#main>div .format .panels>*>.sample .lit{color:#6abcff !important}#main>div .format .panels>*>.sample .str{color:#11ce06 !important}#main>div .format .panels>*>.sample .typ{color:#fe03ff !important}#main>div .format .panels>*>.table{overflow-x:auto;display:inline-block;width:100%;border:1px solid #e0e0e0}#main>div .format .panels>*>.table+.table{margin-top:32px}#main>div .format .panels>*>.table>table{display:table;width:100%;min-width:650px;border-spacing:0;border-collapse:collapse;font-size:14px;table-layout:fixed}#main>div .format .panels>*>.table>table th,#main>div .format .panels>*>.table>table td{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}#main>div .format .panels>*>.table>table th.left,#main>div .format .panels>*>.table>table td.left{text-align:left}#main>div .format .panels>*>.table>table th.center,#main>div .format .panels>*>.table>table td.center{text-align:center}#main>div .format .panels>*>.table>table th.edit,#main>div .format .panels>*>.table>table th.right,#main>div .format .panels>*>.table>table td.edit,#main>div .format .panels>*>.table>table td.right{text-align:right}#main>div .format .panels>*>.table>table th.is-need,#main>div .format .panels>*>.table>table td.is-need{width:60px}#main>div .format .panels>*>.table>table th span.need,#main>div .format .panels>*>.table>table th span.maybe,#main>div .format .panels>*>.table>table td span.need,#main>div .format .panels>*>.table>table td span.maybe{display:inline-block;width:50px;height:20px;line-height:20px;font-size:10px;font-weight:bold;color:white;text-align:center;background-color:#bf78ff;-moz-border-radius:10px;-webkit-border-radius:10px;border-radius:10px}#main>div .format .panels>*>.table>table th span.need:before,#main>div .format .panels>*>.table>table th span.maybe:before,#main>div .format .panels>*>.table>table td span.need:before,#main>div .format .panels>*>.table>table td span.maybe:before{content:"必要"}#main>div .format .panels>*>.table>table th span.maybe,#main>div .format .panels>*>.table>table td span.maybe{background-color:#c8c8c8}#main>div .format .panels>*>.table>table th span.maybe:before,#main>div .format .panels>*>.table>table td span.maybe:before{content:"非必要"}#main>div .format .panels>*>.table>table th.key,#main>div .format .panels>*>.table>table td.key{width:180px}#main>div .format .panels>*>.table>table th.type,#main>div .format .panels>*>.table>table td.type{width:120px}#main>div .format .panels>*>.table>table th p,#main>div .format .panels>*>.table>table td p{display:inline-block;width:100%;margin:0}#main>div .format .panels>*>.table>table td.key,#main>div .format .panels>*>.table>table td.type,#main>div .format .panels>*>.table>table td.desc{font-size:13px}#main>div .format .panels>*>.table>table td.desc{word-break:break-all;white-space:normal}#main>div .format .panels>*>.table>table td.desc[data-d4]:not([data-d4=""]):before{content:"預設值：" attr(data-d4);display:block;padding-bottom:4px;margin-bottom:6px;font-weight:bold;line-height:20px;border-bottom:1px dashed #dedede}#main>div .format .panels>*>.table>table thead tr th{padding:0 5px;height:32px;line-height:32px;border-bottom:1px solid #dedede;background-color:#f5f5f5}#main>div .format .panels>*>.table>table thead tr th+*{border-left:1px solid #e0e0e0}#main>div .format .panels>*>.table>table tbody tr td{padding:6px 4px;min-height:32px}#main>div .format .panels>*>.table>table tbody tr td+*{border-left:1px solid #e0e0e0}#main>div .format .panels>*>.table>table tbody tr td a{display:inline;font-weight:normal;text-decoration:none;-moz-transition:color .3s,border-bottom .3s;-o-transition:color .3s,border-bottom .3s;-webkit-transition:color .3s,border-bottom .3s;transition:color .3s,border-bottom .3s;color:#4285f4;border-bottom:1px solid transparent}#main>div .format .panels>*>.table>table tbody tr td a.active,#main>div .format .panels>*>.table>table tbody tr td a:hover{color:#0d5bdd;border-bottom:1px solid #0d5bdd}#main>div .format .panels>*>.table>table tbody tr td:empty:before{content:"-";filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=40);opacity:.4}#main>div .format .panels>*>.table>table tbody tr td[colspan]{text-align:center;padding:10px;font-weight:bold;background-color:white !important}#main>div .format .panels>*>.table>table tbody tr td[colspan]:empty:before{content:"沒有資料。"}#main>div .format .panels>*>.table>table tbody tr+tr td{border-top:1px solid #dedede}#main>div .format .panels>*>.table+.sample{margin-top:32px}#main>div .format[data-i="1"] .panels>*:nth-child(1){left:0%;position:relative;filter:progid:DXImageTransform.Microsoft.Alpha(enabled=false);opacity:1}#main>div .format[data-i="1"] .panels>*:nth-child(2){left:100%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="1"] .panels>*:nth-child(3){left:200%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="1"] .panels>*:nth-child(4){left:300%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="1"] .panels>*:nth-child(5){left:400%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="1"] .tabs>*:nth-child(1){-moz-border-radius-topleft:3px;-webkit-border-top-left-radius:3px;border-top-left-radius:3px;-moz-border-radius-topright:3px;-webkit-border-top-right-radius:3px;border-top-right-radius:3px;height:36px;line-height:36px;margin-top:8px;border-right-width:1px;font-weight:bold;font-size:16px;z-index:3;background-color:#fff}#main>div .format[data-i="1"] .tabs>*:nth-child(1)+*{border-left:0}#main>div .format[data-i="1"] .tabs>*:nth-child(1):after{margin-top:6px;background-color:#b4b4b4}#main>div .format[data-i="2"] .panels>*:nth-child(1){left:-100%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="2"] .panels>*:nth-child(2){left:0%;position:relative;filter:progid:DXImageTransform.Microsoft.Alpha(enabled=false);opacity:1}#main>div .format[data-i="2"] .panels>*:nth-child(3){left:100%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="2"] .panels>*:nth-child(4){left:200%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="2"] .panels>*:nth-child(5){left:300%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="2"] .tabs>*:nth-child(2){-moz-border-radius-topleft:3px;-webkit-border-top-left-radius:3px;border-top-left-radius:3px;-moz-border-radius-topright:3px;-webkit-border-top-right-radius:3px;border-top-right-radius:3px;height:36px;line-height:36px;margin-top:8px;border-right-width:1px;font-weight:bold;font-size:16px;z-index:3;background-color:#fff}#main>div .format[data-i="2"] .tabs>*:nth-child(2)+*{border-left:0}#main>div .format[data-i="2"] .tabs>*:nth-child(2):after{margin-top:6px;background-color:#b4b4b4}#main>div .format[data-i="3"] .panels>*:nth-child(1){left:-200%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="3"] .panels>*:nth-child(2){left:-100%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="3"] .panels>*:nth-child(3){left:0%;position:relative;filter:progid:DXImageTransform.Microsoft.Alpha(enabled=false);opacity:1}#main>div .format[data-i="3"] .panels>*:nth-child(4){left:100%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="3"] .panels>*:nth-child(5){left:200%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="3"] .tabs>*:nth-child(3){-moz-border-radius-topleft:3px;-webkit-border-top-left-radius:3px;border-top-left-radius:3px;-moz-border-radius-topright:3px;-webkit-border-top-right-radius:3px;border-top-right-radius:3px;height:36px;line-height:36px;margin-top:8px;border-right-width:1px;font-weight:bold;font-size:16px;z-index:3;background-color:#fff}#main>div .format[data-i="3"] .tabs>*:nth-child(3)+*{border-left:0}#main>div .format[data-i="3"] .tabs>*:nth-child(3):after{margin-top:6px;background-color:#b4b4b4}#main>div .format[data-i="4"] .panels>*:nth-child(1){left:-300%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="4"] .panels>*:nth-child(2){left:-200%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="4"] .panels>*:nth-child(3){left:-100%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="4"] .panels>*:nth-child(4){left:0%;position:relative;filter:progid:DXImageTransform.Microsoft.Alpha(enabled=false);opacity:1}#main>div .format[data-i="4"] .panels>*:nth-child(5){left:100%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="4"] .tabs>*:nth-child(4){-moz-border-radius-topleft:3px;-webkit-border-top-left-radius:3px;border-top-left-radius:3px;-moz-border-radius-topright:3px;-webkit-border-top-right-radius:3px;border-top-right-radius:3px;height:36px;line-height:36px;margin-top:8px;border-right-width:1px;font-weight:bold;font-size:16px;z-index:3;background-color:#fff}#main>div .format[data-i="4"] .tabs>*:nth-child(4)+*{border-left:0}#main>div .format[data-i="4"] .tabs>*:nth-child(4):after{margin-top:6px;background-color:#b4b4b4}#main>div .format[data-i="5"] .panels>*:nth-child(1){left:-400%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="5"] .panels>*:nth-child(2){left:-300%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="5"] .panels>*:nth-child(3){left:-200%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="5"] .panels>*:nth-child(4){left:-100%;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);opacity:0}#main>div .format[data-i="5"] .panels>*:nth-child(5){left:0%;position:relative;filter:progid:DXImageTransform.Microsoft.Alpha(enabled=false);opacity:1}#main>div .format[data-i="5"] .tabs>*:nth-child(5){-moz-border-radius-topleft:3px;-webkit-border-top-left-radius:3px;border-top-left-radius:3px;-moz-border-radius-topright:3px;-webkit-border-top-right-radius:3px;border-top-right-radius:3px;height:36px;line-height:36px;margin-top:8px;border-right-width:1px;font-weight:bold;font-size:16px;z-index:3;background-color:#fff}#main>div .format[data-i="5"] .tabs>*:nth-child(5)+*{border-left:0}#main>div .format[data-i="5"] .tabs>*:nth-child(5):after{margin-top:6px;background-color:#b4b4b4}#footer{position:fixed;bottom:0;left:0;display:inline-block;width:319px;height:32px;line-height:32px;background-color:white;-moz-box-shadow:-1px 0 2px rgba(0,0,0,0.13);-webkit-box-shadow:-1px 0 2px rgba(0,0,0,0.13);box-shadow:-1px 0 2px rgba(0,0,0,0.13);border-top:1px solid rgba(0,0,0,0.15);font-size:13px}#footer a{display:inline;font-weight:normal;text-decoration:none;-moz-transition:color .3s,border-bottom .3s;-o-transition:color .3s,border-bottom .3s;-webkit-transition:color .3s,border-bottom .3s;transition:color .3s,border-bottom .3s;color:#4285f4;border-bottom:1px solid #4285f4;margin-left:2px;cursor:pointer}#footer a.active,#footer a:hover{color:#0d5bdd;border-bottom:1px solid #0d5bdd}html body.t1{background-color:#323232;color:#fff}html body.t1 #footer{background-color:#5f5f5f;border-top:0;-moz-box-shadow:-1px 0 2px rgba(0,0,0,0.43);-webkit-box-shadow:-1px 0 2px rgba(0,0,0,0.43);box-shadow:-1px 0 2px rgba(0,0,0,0.43);color:#c8c8c8}html body.t1 #footer a{color:white;border-bottom:1px solid white}html body.t1 #main>div>header>section>p{color:#b4b4b4}html body.t1 #main>div .important>div span{color:#99e1f8}html body.t1 #main>div .important>div span:before{background-color:#b5241c;color:white;border:0;-moz-box-shadow:1px 1px 1px rgba(0,0,0,0.5),inset 1px 1px 1px rgba(255,255,255,0.1);-webkit-box-shadow:1px 1px 1px rgba(0,0,0,0.5),inset 1px 1px 1px rgba(255,255,255,0.1);box-shadow:1px 1px 1px rgba(0,0,0,0.5),inset 1px 1px 1px rgba(255,255,255,0.1)}html body.t1 #main>div .important>div{background-color:#2c2c2c;border:1px solid #5a5a5a;border-bottom-width:0}html body.t1 #main>div .important>div:last-child{border-bottom-width:1px}html body.t1 #main>div .important>div+div{border-top:1px dashed #5a5a5a}html body.t1 #main>div .important>div p{color:#b4b4b4}html body.t1 #main>div .important>div p code{color:#fafafb;background-color:#1c1c1c;padding:0 8px;font-weight:bold;font-size:15px;text-shadow:1px 1px 1px rgba(0,0,0,0.5);-moz-box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1);-webkit-box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1);box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1)}html body.t1 #main>div .format .tabs>*{background-color:#2c2c2c;border-color:#464646;padding:0 20px}html body.t1 #main>div .format .tabs:after{background-color:#464646;-moz-box-shadow:none;-webkit-box-shadow:none;box-shadow:none}html body.t1 #main>div .format[data-i="1"] .tabs>*:nth-child(1){background-color:#333;background-color:#333;background-color:#333;background-color:#333}html body.t1 #main>div .format[data-i="2"] .tabs>*:nth-child(2){background-color:#333;background-color:#333;background-color:#333;background-color:#333}html body.t1 #main>div .format[data-i="3"] .tabs>*:nth-child(3){background-color:#333;background-color:#333;background-color:#333;background-color:#333}html body.t1 #main>div .format[data-i="4"] .tabs>*:nth-child(4){background-color:#333;background-color:#333;background-color:#333;background-color:#333}html body.t1 #main>div .format[data-i="5"] .tabs>*:nth-child(5){background-color:#333;background-color:#333;background-color:#333;background-color:#333}html body.t1 #main>div .format .panels>*>.table{border-color:#464646}html body.t1 #main>div .format .panels>*>.table>table{font-size:16px}html body.t1 #main>div .format .panels>*>.table>table thead tr td,html body.t1 #main>div .format .panels>*>.table>table thead tr th,html body.t1 #main>div .format .panels>*>.table>table tbody tr td,html body.t1 #main>div .format .panels>*>.table>table tbody tr th{border-color:#464646}html body.t1 #main>div .format .panels>*>.table>table thead tr td.is-need,html body.t1 #main>div .format .panels>*>.table>table thead tr th.is-need,html body.t1 #main>div .format .panels>*>.table>table tbody tr td.is-need,html body.t1 #main>div .format .panels>*>.table>table tbody tr th.is-need{width:70px}html body.t1 #main>div .format .panels>*>.table>table thead tr th{padding:3px 8px;color:#c8c8c8;background-color:#2a2a2a}html body.t1 #main>div .format .panels>*>.table>table tbody tr td{background-color:#363636;padding:12px 8px}html body.t1 #main>div .format .panels>*>.table>table tbody tr td.key,html body.t1 #main>div .format .panels>*>.table>table tbody tr td.type,html body.t1 #main>div .format .panels>*>.table>table tbody tr td.desc{font-size:16px}html body.t1 #main>div .format .panels>*>.table>table tbody tr td span.maybe{background-color:#5e625d}html body.t1 #main>div .format .panels>*>.table>table tbody tr td span.need{background-color:#ac201a}html body.t1 #main>div .format .panels>*>.table>table td.desc[data-d4]:not([data-d4=""]):before{display:inline-block;width:auto;border:0;-moz-border-radius:3px;-webkit-border-radius:3px;border-radius:3px;background-color:#1e1e1e;padding:3px 8px;font-size:14px;text-shadow:1px 1px 1px rgba(0,0,0,0.5);-moz-box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1);-webkit-box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1);box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1)}html body.t1 #main>div .format .panels>*>.sample{background-color:#242424;-moz-box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1);-webkit-box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1);box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1)}html body.t1 #main>div .format .panels>*>.sample .pln,html body.t1 #main>div .format .panels>*>.sample .pun{color:white !important}html body.t1 #main>div .format .panels>*>.sample .lit{color:#6abcff !important}html body.t1 #main>div .format .panels>*>.sample .str{color:#b3df53 !important}html body.t1 #main>div .format .panels>*>.sample .typ{color:#ff3e39 !important}html body.t1 #main>div .format .panels>*>.sample .kwd{color:#a485f4 !important}html body.t1 #main>div .url{padding-left:90px}html body.t1 #main>div .url[data-type]:not([data-type=""]):before{content:attr(data-type);-moz-box-shadow:inset 1px 1px 1px rgba(255,255,255,0.3),inset -1px -1px 1px #000;-webkit-box-shadow:inset 1px 1px 1px rgba(255,255,255,0.3),inset -1px -1px 1px #000;box-shadow:inset 1px 1px 1px rgba(255,255,255,0.3),inset -1px -1px 1px #000;-moz-border-radius-topleft:22px;-webkit-border-top-left-radius:22px;border-top-left-radius:22px;-moz-border-radius-bottomleft:22px;-webkit-border-bottom-left-radius:22px;border-bottom-left-radius:22px;padding-left:4px;width:90px}html body.t1 #main>div .url[data-type]:not([data-type=""])[data-type="get" i]:before{content:"Get";background-color:#65b74c}html body.t1 #main>div .url[data-type]:not([data-type=""])[data-type="post" i]:before{content:"Post";background-color:#6e90e8}html body.t1 #main>div .url[data-type]:not([data-type=""])[data-type="put" i]:before{content:"Put";background-color:#e6be00}html body.t1 #main>div .url[data-type]:not([data-type=""])[data-type="delete" i]:before{content:"Del";background-color:#ea443b}html body.t1 #main>div .url>pre{background-color:#202020;text-shadow:1px 1px 1px rgba(0,0,0,0.5);-moz-box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1);-webkit-box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1);box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1);-moz-border-radius-topright:22px;-webkit-border-top-right-radius:22px;border-top-right-radius:22px;-moz-border-radius-bottomright:22px;-webkit-border-bottom-right-radius:22px;border-bottom-right-radius:22px}html body.t1 #menu{border-right:1px solid #464646;background-color:#3c3c3c}html body.t1 #menu::-webkit-scrollbar-thumb{background-color:rgba(100,100,100,0);-moz-border-radius:4px;-webkit-border-radius:4px;border-radius:4px}html body.t1 #menu::-webkit-scrollbar{background-color:transparent;width:0}html body.t1 #apis>div{border-top:1px solid #5f5f5f;border-bottom:1px solid #5a5a5a}html body.t1 #apis>div:before{text-shadow:none}html body.t1 #apis>div:after{background-color:#2d2d2d;color:#c8c8c8;-moz-box-shadow:0 0 1px rgba(255,255,255,0.15),1px 1px 1px rgba(255,255,255,0.2);-webkit-box-shadow:0 0 1px rgba(255,255,255,0.15),1px 1px 1px rgba(255,255,255,0.2);box-shadow:0 0 1px rgba(255,255,255,0.15),1px 1px 1px rgba(255,255,255,0.2);text-shadow:none}html body.t1 #apis>div>a{background-color:#333;color:#fafafa;-moz-transition:background-color .3s;-o-transition:background-color .3s;-webkit-transition:background-color .3s;transition:background-color .3s}html body.t1 #apis>div>a:after{color:#848484;border-bottom:1px solid #5a5a5a}html body.t1 #apis>div>a:last-child:after{border-bottom:0}html body.t1 #apis>div>a:hover{background-color:#414141}html body.t1 #apis>div>a.active{color:#fafafa;background-color:#464646}html body.t1 #apis>div>a.active:after{color:#b4b4b4}html body.t1 #apis>div>a[data-type]:not([data-type=""]):before{background-color:#282828;-moz-box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1);-webkit-box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1);box-shadow:inset 1px 1px 1px rgba(0,0,0,0.5),1px 1px 1px rgba(255,255,255,0.1);font-weight:bold;font-size:15px;text-shadow:1px 1px 1px rgba(0,0,0,0.5)}html body.t1 #apis>div>a[data-type]:not([data-type=""])[data-type="get" i]:before{color:#65b74c}html body.t1 #apis>div>a[data-type]:not([data-type=""])[data-type="post" i]:before{color:#6e90e8}html body.t1 #apis>div>a[data-type]:not([data-type=""])[data-type="put" i]:before{color:#e6be00}html body.t1 #apis>div>a[data-type]:not([data-type=""])[data-type="delete" i]:before{color:#ea443b}html body.t1 #search{background-color:#414141;border-bottom:1px solid #5a5a5a}html body.t1 #search input{background-color:#4b4b4b;border:1px solid #787878;color:#787878;padding-left:8px;padding-right:8px;-moz-border-radius:15px;-webkit-border-radius:15px;border-radius:15px;-moz-transition:background-color .3s,color .3s;-o-transition:background-color .3s,color .3s;-webkit-transition:background-color .3s,color .3s;transition:background-color .3s,color .3s}html body.t1 #search input:focus{outline:0;color:#fff;background-color:#5a5a5a;-moz-box-shadow:none;-webkit-box-shadow:none;box-shadow:none}#logo{position:fixed;top:16px;right:32px;display:inline-block;width:44px;height:44px;cursor:pointer;z-index:999;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=40);opacity:.4;-moz-transition:opacity .3s;-o-transition:opacity .3s;-webkit-transition:opacity .3s;transition:opacity .3s}#logo svg{width:100%}#logo:hover{filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=80);opacity:.8}#logo:not(.go){-moz-animation:l 4s linear infinite;-webkit-animation:l 4s linear infinite;animation:l 4s linear infinite}#logo.go{-moz-animation:go 2s linear infinite;-webkit-animation:go 2s linear infinite;animation:go 2s linear infinite}@-moz-keyframes l{0%{-moz-transform:rotate(0);transform:rotate(0)}100%{-moz-transform:rotate(360deg);transform:rotate(360deg)}}@-webkit-keyframes l{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes l{0%{-moz-transform:rotate(0);-ms-transform:rotate(0);-webkit-transform:rotate(0);transform:rotate(0)}100%{-moz-transform:rotate(360deg);-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-moz-keyframes go{0%{right:32px;-moz-transform:rotate(0);transform:rotate(0)}50%{right:150px;-moz-transform:rotate(-360deg);transform:rotate(-360deg)}100%{right:32px;-moz-transform:rotate(0);transform:rotate(0)}}@-webkit-keyframes go{0%{right:32px;-webkit-transform:rotate(0);transform:rotate(0)}50%{right:150px;-webkit-transform:rotate(-360deg);transform:rotate(-360deg)}100%{right:32px;-webkit-transform:rotate(0);transform:rotate(0)}}@keyframes go{0%{right:32px;-moz-transform:rotate(0);-ms-transform:rotate(0);-webkit-transform:rotate(0);transform:rotate(0)}50%{right:150px;-moz-transform:rotate(-360deg);-ms-transform:rotate(-360deg);-webkit-transform:rotate(-360deg);transform:rotate(-360deg)}100%{right:32px;-moz-transform:rotate(0);-ms-transform:rotate(0);-webkit-transform:rotate(0);transform:rotate(0)}}</style>' . "\n" . '    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>' . "\n" . '    <script src="https://code.jquery.com/jquery-1.10.2.min.js" integrity="sha256-C6CB9UYIS9UJeqinPHWTHVqh/E1uhG5Twh+Y5qFQmYg=" crossorigin="anonymous"></script>' . "\n" . '    <script type="text/javascript">console.log("%c想看更多 OA Wu 的作品集嗎！？快看這裡喲！ %c➜ %chttp://www.ioa.tw/?f=works","color:rgba(36, 127, 84, 1.00);font-size:15px;line-height:25px;","color:rgba(213, 36, 35, 1.00);font-size:15px;line-height:25px;","color:rgba(66, 133, 244, 1.00);font-size:10px;line-height:25px;"),$(function(){var p={val:{},init:function(){window.location.hash.substr(1).split("&").forEach(function(t){var a=t.split("=");if(2==a.length){var e=decodeURIComponent(a[0]),n=decodeURIComponent(a[1]);"[]"==e.slice(-2)?p.val[e=e.slice(0,-2)]?p.val[e].push(n):p.val[e]=[n]:p.val[e]=n}}),p.val.n=p.val.n?p.val.n:"",p.val.t=p.val.t?p.val.t:"",p.val.q=p.val.q?p.val.q:""},update:function(t,a){if(void 0!==p.val[t]){p.val[t]=a,"q"==t&&(p.val.n="",p.val.t="");var e=[];for(var n in p.val)e.push(n+"="+p.val[n]);window.location.hash=e.join("&")}}},l={$el:$("#load"),init:function(){$.get("api_project.json?t="+(new Date).getTime()).done(l.render).fail(function(){l.render({name:"API 文件",description:"",version:"0.0.0"})})},render:function(t){$("title").text(t.name),l.$el.append($("<div />").append($("<h1 />").text(t.name)).append($("<p />").text(t.description)).append($("<div />").append($("<i />")).append($("<i />")).append($("<i />"))).append($("<span />").text("版本：v"+t.version)))},hide:function(t){l.$el&&(l.$el.addClass("hide"),setTimeout(function(){l.$el.remove(),l.$el=null,t&&t()},375))}},s={$el:$("#main"),$tabs:null,$panels:null,$format:null,init:function(){var t=$("<div />");s.$el.empty().append(t),s.$el=t},render:function(t){s.$el.empty();var a={name:"",title:"",description:"",permission:[]};for(var e in a)void 0===t[e]&&(t[e]=a[e]);var n=$("<header />").append($("<h1 />").attr("data-title",t.name).text(t.title)).append($("<section />").html(t.description)),i=$("<div />").addClass("important").append(t.permission.map(function(t){return $("<div />").append($("<span />").text(t.name)).append($("<div />").text(t.title)).append($(t.description))})),l=$("<div />").addClass("url").attr("data-type",t.type).append($("<pre />").text(t.url)),d={header:{title:"Header",d4:"Header",v:"h"},parameter:{title:"參數",d4:"Parameter",v:"p"},success:{title:"成功",d4:"Success 200",v:"s"},error:{title:"錯誤",d4:"Error 4xx",v:"e"}};for(var r in s.$tabs=[],s.$panels=[],d)void 0!==t[r]&&(s.$tabs.push(d[r]),s.$panels.push({d4:d[r].d4,fields:void 0===t[r].fields?{}:t[r].fields,examples:void 0===t[r].examples?[]:t[r].examples}));s.$tabs=$(s.$tabs.map(function(t){return $("<a />").attr("data-name",t.v).text(t.title).click(function(){p.update("t",$(this).attr("data-name")),s.$format.attr("data-i",$(this).index()+1)})})).map($.fn.toArray),s.$panels=$(s.$panels.map(function(e){var t=$("<div />"),a=[];for(var n in e.fields)a.push($.extend(e.fields[n],{title:e.d4==n?"":n}));return a.sort(function(t,a){return t.title>a.title}),t.append(a.map(function(t){var a=$("<div />").addClass("table").append($("<table />").append($("<thead />").append($("<tr />").append($("<th />").addClass("center").addClass("is-need").text("必須")).append($("<th />").addClass("key").text("Key")).append($("<th />").addClass("type").text("類型")).append($("<th />").addClass("desc").text("敘述")))).append($("<tbody />").append(t.map(function(t){return $("<tr />").append($("<td />").addClass("center").append($("<span />").addClass(t.optional?"maybe":"need"))).append($("<td />").addClass("key").text(t.field)).append($("<td />").addClass("type").text(t.type)).append($("<td />").addClass("desc").attr("data-d4",void 0!==t.defaultValue?t.defaultValue:"").html(t.description))}))));return t.title.length?$("<h3 />").text(t.title).add(a):a})),t.append(e.examples.map(function(t){var a=$("<pre />").addClass("prettyprint").addClass("language-"+t.type).addClass("sample").text(t.content);return 1<e.examples.length?$("<h3 />").text(t.title).add(a):a})),t})).map($.fn.toArray),s.$format=$("<div />").addClass("format").append($("<div />").addClass("tabs").append(s.$tabs)).append($("<div />").addClass("panels").append(s.$panels)),p.val.t.length&&s.$tabs.filter(\'[data-name="\'+p.val.t+\'"]\').length?s.$tabs.filter(\'[data-name="\'+p.val.t+\'"]\').first().click():s.$tabs.first().click(),s.$el.append(n).append(i).append(l).append(s.$format),PR.prettyPrint()}},d={$el:$("#menu"),$search:null,$apis:null,$links:null,apis:null,init:function(){d.$el.empty(),d.$search=$("<form />").attr("id","search").append($("<input />").val(p.val.q).attr("placeholder","你想找什麼？").prop("required",!0).keyup(function(){p.update("q",$(this).val().trim()),d.filter(p.val.q)})).submit(function(){return!1}),d.$apis=$("<div />").attr("id","apis"),d.$el.append(d.$search),d.$el.append(d.$apis),d.$el.append($("<footer />").attr("id","footer").text("版型設計 by").append($("<a />").attr("href","https://www.ioa.tw/f=apidoc").attr("target","_blank").text("OA Wu")).append("，程式碼：").append($("<a />").attr("href","https://github.com/comdan66/OA-apiDoc-Template.git").attr("target","_blank").text("GitHub"))),null===d.apis?$.get("api_data.json?t="+(new Date).getTime()).done(function(t){d.apis=t,d.filter(p.val.q)}).fail(function(){d.apis=[],d.filter(p.val.q)}):d.filter(p.val.q)},filter:function(e){e="object"==typeof(e="string"==typeof(e=void 0===e?"":e)?e.trim():e)?$(this).val().trim():e,d.$apis.empty();var t=d.apis.filter(function(t){var a=new RegExp(e,"gi");return e.length?t.type.match(a)||t.url.match(a)||t.title.match(a)||t.group.match(a):t}),a={};for(var n in t.forEach(function(t){void 0===t.group&&(t.group=""),void 0===a[t.group]&&(a[t.group]=[]),a[t.group].push(t)}),d.$links=[],a){var i=a[n].map(function(t){return $("<a />").attr("data-name",t.name).attr("data-type",t.type).attr("data-url",t.url).text(t.title).data("obj",t).click(function(){p.update("n",$(this).data("name")),d.$links.removeClass("active"),$(this).addClass("active"),s.render($(this).data("obj"))})});d.$apis.append($("<div />").attr("data-title",n).attr("data-cnt",a[n].length).append(i)),d.$links.push(i)}d.$links=$(d.$links.length?d.$links.reduce(function(t,a){return t.concat(a)}):[]).map($.fn.toArray),d.$links.length?(d.$apis.removeAttr("data-tip"),s.$el.removeAttr("data-tip"),p.val.n.length&&d.$links.filter(\'[data-name="\'+p.val.n+\'"]\').length?d.$links.filter(\'[data-name="\'+p.val.n+\'"]\').first().click():d.$links.first().click()):(d.$apis.attr("data-tip","找不到任何 API"),s.$el.attr("data-tip","找不到任何 API 資訊")),l.hide(function(){})}},e={i:function(){return"undefined"!=typeof Storage},s:function(t,a){try{return!!e.i()&&(localStorage.setItem(t,JSON.stringify(a)),!0)}catch(t){return console.error("設定 storage 失敗！",error),!1}},g:function(t){return e.i()&&(value=localStorage.getItem(t))&&(value=JSON.parse(value))?value:void 0}};p.init(),l.init(),s.init(),d.init();var t=e.g("OA-apiDoc-Template"),a=$("body");t&&a.addClass(t),$("#logo").click(function(){if($(this).hasClass("go"))return!1;$(this).addClass("go"),e.s("OA-apiDoc-Template",a.toggleClass("t1").hasClass("t1")?"t1":null),setTimeout(function(){$(this).removeClass("go")}.bind($(this)),2e3)}),$(window).keydown(function(t){var a,e=parseInt(s.$format.attr("data-i")),n=s.$tabs.length;return 38==t.keyCode?(a=d.$links.filter(".active").prev()).length?a.click():(a=d.$links.filter(".active").parent().prev()).length?a.find(">*").last().click():(a=d.$apis.find(">*").last()).find(">*").last().click():40==t.keyCode?(a=d.$links.filter(".active").next()).length?a.click():(a=d.$links.filter(".active").parent().next()).length?a.find(">*").first().click():(a=d.$apis.find(">*").first()).find(">*").first().click():(39==t.keyCode&&(s.$format.attr("data-i",++e>n?e=1:e),p.update("t",s.$tabs.eq(e-1).attr("data-name"))),void(37==t.keyCode&&(s.$format.attr("data-i",--e<1?e=n:e),p.update("t",s.$tabs.eq(e-1).attr("data-name")))))})});</script>' . "\n" . "\n" . '  </head>' . "\n" . '  <body lang="zh-tw">' . "\n" . '    <div id="menu"></div>' . "\n" . '    <div id="main"></div>' . "\n" . '    <div id="load"></div>' . "\n" . '    <div id="logo"><svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"><g><rect x="241" style="fill:#A59D4D;" width="30" height="45"/><rect x="173.067" y="15.454" transform="matrix(-0.2588 -0.9659 0.9659 -0.2588 216.7646 227.2375)" style="fill:#A59D4D;" width="44.999" height="29.999"/><rect x="116.749" y="38.782" transform="matrix(-0.5 -0.866 0.866 -0.5 162.2987 201.2658)" style="fill:#A59D4D;" width="44.999" height="29.999"/><rect x="68.39" y="75.889" transform="matrix(-0.7071 -0.7071 0.7071 -0.7071 90.8893 219.4262)" style="fill:#A59D4D;" width="45" height="30"/><rect x="31.279" y="124.245" transform="matrix(-0.866 -0.5 0.5 -0.866 30.7279 286.7227)" style="fill:#A59D4D;" width="44.999" height="29.999"/><rect x="7.96" y="180.565" transform="matrix(-0.9659 -0.2588 0.2588 -0.9659 9.2666 392.3481)" style="fill:#A59D4D;" width="44.999" height="29.999"/><rect y="241" style="fill:#A59D4D;" width="45" height="30"/><rect x="15.473" y="293.93" transform="matrix(-0.2588 -0.9659 0.9659 -0.2588 -267.2896 427.758)" style="fill:#A59D4D;" width="29.999" height="44.999"/><rect x="38.79" y="350.252" transform="matrix(-0.5 -0.866 0.866 -0.5 -242.1239 605.7139)" style="fill:#A59D4D;" width="29.999" height="44.999"/><rect x="75.892" y="398.606" transform="matrix(-0.7071 -0.7071 0.7071 -0.7071 -142.6042 783.1432)" style="fill:#A59D4D;" width="30" height="45"/><rect x="124.251" y="435.709" transform="matrix(-0.866 -0.5 0.5 -0.866 30.7348 924.6526)" style="fill:#A59D4D;" width="29.999" height="44.999"/><rect x="180.579" y="459.024" transform="matrix(-0.9659 -0.2588 0.2588 -0.9659 259.8716 997.2572)" style="fill:#A59D4D;" width="29.999" height="44.999"/><rect x="241" y="467" style="fill:#A59D4D;" width="30" height="45"/><rect x="293.943" y="466.523" transform="matrix(-0.2588 -0.9659 0.9659 -0.2588 -66.7759 911.805)" style="fill:#A59D4D;" width="44.999" height="29.999"/><rect x="350.257" y="443.212" transform="matrix(-0.5 -0.866 0.866 -0.5 162.319 1010.1365)" style="fill:#A59D4D;" width="44.999" height="29.999"/><rect x="398.61" y="406.104" transform="matrix(-0.7071 -0.7071 0.7071 -0.7071 421.1144 1016.6387)" style="fill:#A59D4D;" width="45" height="30"/><rect x="435.704" y="357.742" transform="matrix(-0.866 -0.5 0.5 -0.866 668.6417 924.6495)" style="fill:#A59D4D;" width="44.999" height="29.999"/><rect x="459.038" y="301.413" transform="matrix(-0.9659 -0.2588 0.2588 -0.9659 864.7783 746.6697)" style="fill:#A59D4D;" width="44.999" height="29.999"/><rect x="467" y="241" style="fill:#A59D4D;" width="45" height="30"/><rect x="466.532" y="173.044" transform="matrix(-0.2588 -0.9659 0.9659 -0.2588 417.2749 711.2762)" style="fill:#A59D4D;" width="29.999" height="44.999"/><rect x="443.22" y="116.744" transform="matrix(-0.5 -0.866 0.866 -0.5 566.7468 605.6936)" style="fill:#A59D4D;" width="29.999" height="44.999"/><rect x="406.109" y="68.385" transform="matrix(-0.7071 -0.7071 0.7071 -0.7071 654.6117 452.9194)" style="fill:#A59D4D;" width="30" height="45"/><rect x="357.742" y="31.279" transform="matrix(-0.866 -0.5 0.5 -0.866 668.6529 286.7265)" style="fill:#A59D4D;" width="29.999" height="44.999"/><rect x="301.423" y="7.95" transform="matrix(-0.9659 -0.2588 0.2588 -0.9659 614.184 141.7543)" style="fill:#A59D4D;" width="29.999" height="44.999"/></g><path style="fill:#707741;" d="M256,30c124.82,0,226,101.18,226,226S380.82,482,256,482L90,256L256,30z"/><path style="fill:#8A8A47;" d="M256,30v452C131.18,482,30,380.82,30,256S131.18,30,256,30z"/><path style="fill:#A59D4D;" d="M256,60c108.251,0,196,87.749,196,196s-87.749,196-196,196L112.035,256L256,60z"/><path style="fill:#BFB053;" d="M256,60v392c-108.251,0-196-87.749-196-196S147.749,60,256,60z"/><path style="fill:#480306;" d="M379.5,154.21l-187,59.99L256,422.21l34.09-34.09C358.11,372.43,407,311.29,407,241 C407,208.72,396.82,178.78,379.5,154.21z"/><path style="fill:#FEDD90;" d="M256,90c50.98,0,96.15,25.4,123.5,64.21c-0.01,33-27,59.99-60,59.99H256l-60-62.1L256,90z"/><path style="fill:#8B2613;" d="M132.5,154.21C115.18,178.78,105,208.72,105,241c0,70.29,48.89,131.43,116.91,147.12L256,422.21 V214.2L132.5,154.21z"/><path style="fill:#FFF2A3;" d="M256,90v124.2h-63.5c-33,0-59.99-26.99-60-59.99C159.85,115.4,205.02,90,256,90z"/><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg></div>' . "\n" . '  </body>' . "\n" . '</html>' . "\n",
      ]
    ];

    echo "\n" . cc(" 【建立結構】", "y") . ($dirs ? "" : "\n");
    dirsMaker($dirs);
    
    echo "\n";
    echo cc(" 【初始完成】", "R") . "\n";
    echo sr(" ", 4) . cc("➤ ", "c2") . "已經初始化成功囉！" . "\n";
    echo sr(" ", 4) . cc("➤ ", "c2") . "現在專案已是" . cc($cho != '3' ? $cho == '1' ? '開發環境' : '測試環境' : '正式環境', 'w2') . cc($cho != '3' ? $cho == '1' ? '(development)' : '(testing)' : '(production)', 'w0') . "\n";
    echo sr(" ", 4) . cc("➤ ", "c2") . "趕緊來開發專案吧！" . "\n";
    echo "\n";
  }
}

if (!function_exists('create1')) {
  function create1($menu) {
    $createMigration = function($name, &$err = '') {
      if (!isReallyWritable(PATH_MIGRATION)) {
        $err = '您的 Migration 資料夾沒有讀寫權限！';
        return false;
      }

      $files = array_keys(Migration::files());
      $version = $files ? end($files) + 1 : 1;

      if (file_exists($path = PATH_MIGRATION . sprintf('%03s-%s.php', $version, $name))) {
        $err = '您的 Migration 名稱重複！';
        return false;
      }

      $content = "<?php defined('MAPLE') || exit('此檔案不允許讀取！');\n\nreturn [\n  'up' => \"\",\n\n  'down' => \"\",\n\n  'at' => \"" . date('Y-m-d H:i:s') . "\"\n];\n";
      fileWrite($path, $content) || exit("\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(' 警告！ ', 'Y', 'r') . cc('您的 Migration 寫入失敗！' . sr(' ', CLI_LEN - 33), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n\n");

      $err = $path;
      return true;
    };

    $menu('1');
    $check = $name = '';

    do {
      $menu('1');
      echo "\n " . cc('➜', 'R') . ' 請輸入要建立的檔名：' . ($name ? $name . "\n" : '');

      if ($name || ($name = trim(fgets(STDIN)))) {
        echo " " . cc('➜', 'R') . ' 檔名「' . cc($name, 'W') . '」是否正確' . cc('[y：沒錯, n：不是]', 'w0') . '：';
        ($check = strtolower(trim(fgets(STDIN)))) == 'n' && $name = '';
      }
    } while ($check != 'y');

    exit("\n" . cc(sr('═', CLI_LEN), 'w0') . "\n"
       . "\n " . cc('➤', 'R') . ' Migration「' . cc($name, 'W') . '」建立中.. ' . ($createMigration($name, $err) ? cc('成功！', 'g')
       . "\n" . ' ' . cc('➤', 'R') . ' 已經成功建立 Migration：' . cc($err, 'W') . "\n" : cc('失敗！', 'r')
       . "\n" . ' ' . cc('➤', 'R') . ' 錯誤原因：' . cc($err, 'W') . "\n")
       . "\n");
  }
}

if (!function_exists('create2')) {
  function create2($menu) {
    $checkColumnHasDouble = function($c1, $c2) {
      if (!$c1) return false;
      if (!$c2) return false;
      foreach ($c2 as $c) if (in_array($c, $c1)) return true;
      return false;
    };

    $createModel = function($name, array $imgUploads, array $fileUploads) {
      $imgUploads = array_map(function($t) use ($name) {return [$t, $name . ucfirst($t), 'ImageUploader']; }, $imgUploads);
      $fileUploads = array_map(function($t) use ($name) { return [$t, $name . ucfirst($t), 'FileUploader']; }, $fileUploads);
      
      $uploader = implode("\n", array_map(function($uploader) { return "    '" . $uploader[0] . "' => '" . $uploader[1] . $uploader[2] . "',"; }, array_merge($imgUploads, $fileUploads)));
      $uploader = $uploader ? "  static \$uploaders = [\n" . $uploader . "\n  ];\n" . "\n" . "  public function putFiles(\$files) {\n    foreach (\$files as \$key => \$file)\n      if (\$file && isset(\$this->\$key) && \$this->\$key instanceof Uploader && !\$this->\$key->put(\$file))\n        return false;\n    return true;\n  }\n" : "  // static \$uploaders = [];\n";

      $imgUploads = array_map(function($uploader) { return "class " . $uploader[1] . $uploader[2] . " extends " . $uploader[2] . " {\n  public function versions() {\n    return [\n      'w100' => ['resize' => [100, 100, 'width']],\n    ];\n  }\n}\n"; }, $imgUploads);
      $fileUploads = array_map(function($uploader) { return "class " . $uploader[1] . $uploader[2] . " extends " . $uploader[2] . " {}\n"; }, $fileUploads);
      $uploaders = array_merge($imgUploads, $fileUploads);
      
      return "<?php\n\nnamespace M;\n\ndefined('MAPLE') || exit('此檔案不允許讀取！');\n\nclass " . $name . " extends Model {\n  // static \$hasOne = [];\n\n  // static \$hasMany = [];\n\n  // static \$belongToOne = [];\n\n  // static \$belongToMany = [];\n\n" . $uploader . "}\n" . ($uploaders ? "\n" . implode("\n", $uploaders) : '');
    };

    $checkModelExist = function($name) {
      return $name !== null ? file_exists(PATH_MODEL . $name . '.php') : false;
    };

    $menu('2');

    isReallyWritable(PATH_MODEL) || exit("\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(' 警告！ ', 'Y', 'r') . cc('您的 Model 資料夾沒有讀寫權限。' . sr(' ', CLI_LEN - 39), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n\n");

    do {
      $name = null;

      do {
        $menu('2');

        echo "\n";
        if ($r = $checkModelExist($name)) {
          echo cc(sr('─', CLI_LEN), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(' 警告！ ', 'Y', 'r') . cc('Model 名稱「', null, 'r') . cc($name, 'W', 'r') . cc('」已經存在，請重新輸入！' .  sr(' ', CLI_LEN - 44 - strlen($name)), null, 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n\n";
          $name = null;
        }

        echo ' ' . cc('➜', 'R') . ' 請輸入 Model 名稱：' . (!$r && $name ? $name . "\n" : '');
        
        $name = trim(fgets(STDIN));
      } while (!$name || $checkModelExist($name));


      $menu('2');
      echo "\n " . cc('➜', 'G') . ' 請輸入 Model 名稱：' . cc($name, 'W')
         . "\n " . cc('➜', 'R') . ' 請輸入 ' . cc('圖片上傳器', 'W') . ' 欄位：';
      
      $imgUploads = trim(fgets(STDIN));
      $imgUploads = array_filter(array_unique(preg_split('/\s+/', $imgUploads)), function($t) { return $t !== ''; });


      $menu('2');
      echo "\n " . cc('➜', 'G') . ' 請輸入 Model 名稱：' . cc($name, 'W')
         . "\n " . cc('➜', 'G') . ' 請輸入 ' . cc('圖片上傳器', 'W') . ' 欄位：' . implode('、', array_map(function($t) { return cc($t, 'W'); }, $imgUploads))
         . "\n " . cc('➜', 'R') . ' 請輸入 ' . cc('檔案上傳器', 'W') . ' 欄位：';
      
      $fileUploads = trim(fgets(STDIN));
      $fileUploads = array_filter(array_unique(preg_split('/\s+/', $fileUploads)), function($t) { return $t !== ''; });

      $checkColumnHasDouble($imgUploads, $fileUploads) && exit("\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(' 警告！ ', 'Y', 'r') . cc('檔案上傳器有欄位與圖片上傳器欄位相衝突！ ', 'W', 'r') . cc(sr(' ', CLI_LEN - 49), null, 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n\n");

      do {
        $menu('2');
        echo "\n " . cc('➜', 'G') . ' 請輸入 Model 名稱：' . cc($name, 'W')
           . "\n " . cc('➜', 'G') . ' 請輸入 ' . cc('圖片上傳器', 'W') . ' 欄位：' . implode('、', array_map(function($t) { return cc($t, 'W'); }, $imgUploads))
           . "\n " . cc('➜', 'G') . ' 請輸入 ' . cc('檔案上傳器', 'W') . ' 欄位：' . implode('、', array_map(function($t) { return cc($t, 'W'); }, $fileUploads));
        
        echo "\n\n " . cc('➜', 'R') . ' 以上資訊是否正確' . cc('[y：沒錯, n：重新填寫]', 'w0') . '：';

        $fin = strtolower(trim(fgets(STDIN)));

      } while (!in_array($fin, ['y', 'n'], true));

    } while ($fin != 'y');
    

    $menu('2');
    echo "\n " . cc('➜', 'G') . ' 請輸入 Model 名稱：' . cc($name, 'W')
       . "\n " . cc('➜', 'G') . ' 請輸入 ' . cc('圖片上傳器', 'W') . ' 欄位：' . implode('、', array_map(function($t) { return cc($t, 'W'); }, $imgUploads))
       . "\n " . cc('➜', 'G') . ' 請輸入 ' . cc('檔案上傳器', 'W') . ' 欄位：' . implode('、', array_map(function($t) { return cc($t, 'W'); }, $fileUploads))
       . "\n";

    Load::sysFunc('file.php');
    $path = PATH_MODEL . $name . '.php';

    exit( "\n" . cc(sr('═', CLI_LEN), 'w0') . "\n"
        . "\n " . cc('➤', 'R') . " 新增 Model「" . cc($name, 'W') . "」- " . (fileWrite($path, $createModel($name, $imgUploads, $fileUploads), 'x') ? cc('成功', 'g') : cc('失敗', 'r'))
        . "\n " . cc('➤', 'R') . " 位置：" . cc($path, 'W')
        . "\n " . cc('➤', 'R') . ' 圖片上傳器欄位：' . ($imgUploads ? implode('、', array_map(function($t) { return cc($t, 'W'); }, $imgUploads)) : cc('無', 'w0'))
        . "\n " . cc('➤', 'R') . ' 檔案上傳器欄位：' . ($fileUploads ? implode('、', array_map(function($t) { return cc($t, 'W'); }, $fileUploads)) : cc('無', 'w0'))
        . "\n\n");
  }
}

if (!function_exists('migration1')) {
  function migration1($version = null, $echo = true, $menu) {
    $cho  = '1';
    $now  = Migration::nowVersion();
    $keys = array_keys(Migration::files(true));
    
    if ($version !== null)
      is_numeric($version) && $version >= 0 && $version <= end($keys) ? $cho = '2' : exit("\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(' 警告！ ', 'Y', 'r') . cc('版本「', null, 'r') . cc($version, 'W', 'r') . cc('」是錯誤的版號，請使用正確的版號', null, 'r') . cc('(0 ~ ' . end($keys) . ')', 'W', 'r') .  cc(sr(' ', CLI_LEN - 55), null, 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n\n");
    else
      $version = end($keys);

    if ($echo) {
      $menu($cho);

      $err = Migration::to($version);
      $menu($cho) && $err === true ?
        exit("\n" . cc(sr('═', CLI_LEN), 'w0') . "\n\n" . cc(' ➤', 'R') . " Migration 更新中，正在由第 " . cc($now, 'W') . ' 版更新至第' . cc($version, 'W') . ' 版' . cc(' ─ ', 'w0') . cc('成功', 'g') . "\n" . cc(' ➤', 'R') . ' 目前已經更新至第 ' . cc(Migration::nowVersion(), 'W') . ' 版！' . "\n\n") :
        exit("\n" . cc(sr('═', CLI_LEN), 'w0') . "\n\n" . cc(' ➤', 'R') . " Migration 更新中，正在由第 " . cc($now, 'W') . ' 版更新至第' . cc($version, 'W') . ' 版' . cc(' ─ ', 'w0') . cc('失敗', 'r') . "\n" . cc(' ➤', 'R') . ' 目前版本只更新到 ' . cc(Migration::nowVersion(), 'W') . ' 版！' . "\n\n"
                  . cc(sr('═', CLI_LEN), 'w0') . "\n\n" . implode("\n", array_map(function($key, $err) { return ' ' . cc('➤', 'B') . ' ' . $key . '：' . cc($err, 'W') . "\n"; }, array_keys($err), $err)) . "\n\n");
    } else {
      $err = Migration::to($version);
      exit(json_encode(['status' => $err === true ? 1 : 0, 'msgs' => $err === true ? [] : $err, 'now' => Migration::nowVersion()]));
    }
  }
}

if (!function_exists('migration2')) {
  function migration2($menu) {
    $keys = array_keys(Migration::files(true));
    $check = $version = '';
    
    do {
      $menu('2');
      echo "\n " . cc('➜', 'R') . " 請輸入要更新的版本號" . cc('(0 ~ ' . end($keys) . ')', 'w0') . "：" . (is_numeric($version) && $version >= 0 && $version <= end($keys) ? $version . "\n" : '');
      is_numeric($version = is_numeric($version) && $version >= 0 && $version <= end($keys) ? $version : trim(fgets(STDIN))) || $version = '';

      if (is_numeric($version) && $version >= 0 && $version <= end($keys)) {
        echo " " . cc('➜', 'R') . ' 您確定要更新至第 ' . cc($version, 'W') . ' 版' . cc('[y：沒錯, n：不是]', 'w0') . '：';
        ($check = strtolower(trim(fgets(STDIN)))) == 'n' && $version = '';
      }
    } while($check != 'y');
    
    migration1($version, true, $menu);
  }
}

if (!function_exists('clean')) {
  function clean($cho, $echo = true) {

    $files = [];
    $cho == '1' && $files = arrayFlatten(array_filter([PATH_CACHE, PATH_TMP, PATH_SESSION], function($dir) { return array_filter(dirMap($dir), function($file) use ($dir) { return $file !== 'index.html' ? !@unlink($dir . $file) ? $dir . $file : false : false; }); }));
    $cho == '2' && $files = arrayFlatten(array_filter([PATH_CACHE], function($dir) { return array_filter(dirMap($dir), function($file) use ($dir) { return $file !== 'index.html' ? !@unlink($dir . $file) ? $dir . $file : false : false; }); }));
    $cho == '3' && $files = arrayFlatten(array_filter([PATH_TMP], function($dir) { return array_filter(dirMap($dir), function($file) use ($dir) { return $file !== 'index.html' ? !@unlink($dir . $file) ? $dir . $file : false : false; }); }));
    $cho == '4' && $files = arrayFlatten(array_filter([PATH_SESSION], function($dir) { return array_filter(dirMap($dir), function($file) use ($dir) { return $file !== 'index.html' ? !@unlink($dir . $file) ? $dir . $file : false : false; }); }));

    $str = '';
    if ($files)
      $str = $echo ? "\n" . cc(sr('═', CLI_LEN), 'N') . "\n\n " . cc(' ➤ ', 'R') . cc('清除失敗！', 'r') . '無法清除的資訊如下：' . "\n" . implode("\n", array_map(function($file) { return '  ' . cc('➜', 'G') . ' 檔案位置：' . cc($file, 'W'); }, $files)) . "\n\n" : json_encode(['status' => 0, 'msgs' => ['錯誤原因' => '清除失敗！', '無法刪除的檔案' => $files]]);
    else
      $str = $echo ? "\n" . cc(sr('═', CLI_LEN), 'N') . "\n\n" . cc(' ➤', 'R') . " 全部已清除完畢！" . "\n\n" : json_encode(['status' => 1, 'msgs' => []]);

    exit($str);
  }
}

if (!function_exists('deploy')) {
  function deploy($stage) {
    system('clear');
    echo Logo::show();
    echo "\n";
    echo cc(' 【部署專案】', 'R') . "\n";
    echo sr(' ', 4) . cc('➤ ', 'c2') . '注意喔，過程中請勿隨意結束！' . "\n";
    echo sr(' ', 4) . cc('➤ ', 'c2') . '坐好囉，我們即將開始幫您部署！' . "\n";

    echo "\n";
    echo cc(' 【本機環境】', 'y') . "\n";

    $title = "\r" . sr(" ", 4) . cc("➤ ", "c2") . "建立 " . cc('deploy.php', 'w2') . " 部署檔案";
    echo $title . cc("… ", "w0");
    $path = PATH_TMP . 'deploy.php';
    fileWrite($path, '<?php' . "\n" . '' . "\n" . 'namespace Deployer;' . "\n" . '' . "\n" . 'PHP_SAPI === "cli" || defined("STDIN") || exit("<!DOCTYPE html><html lang=\"tw\"><head><meta http-equiv=\"Content-Language\" content=\"zh-tw\" /><meta http-equiv=\"Content-type\" content=\"text/html; charset=utf-8\" /><meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui\" /><title>403 禁止訪問 | Maple</title><style type=\"text/css\">*,*:after,*:before{vertical-align:top;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;-moz-osx-font-smoothing:antialiased;-webkit-font-smoothing:antialiased;-moz-font-smoothing:antialiased;-ms-font-smoothing:antialiased;-o-font-smoothing:antialiased}*::-moz-selection,*:after::-moz-selection,*:before::-moz-selection{color:#fff;background-color:#96c8ff}*::selection,*:after::selection,*:before::selection{color:#fff;background-color:#96c8ff}html{height:100%}html body{font-family:Arial, \"微軟正黑體\", \"Microsoft JhengHei\", -apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,\"Helvetica Neue\",Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\",\"Segoe UI Symbol\";height:auto;text-align:center;margin:0;padding:0;font-size:medium;font-weight:normal;color:#555;background-color:#fff;background-color:#f9fafe;position:relative;display:inline-block;width:100%;min-height:100%}.container{display:inline-block}.container .image{margin:250px auto 0 auto;width:180px;height:65px}@media screen and (max-width: 475px) and (min-width: 0){.container .image{margin:120px auto 0 auto;} }.container .image img{width:100%;height:100%}.container .text{display:block;font-size:18px;color:#b5bcbc;margin-top:30px}.container .text a{display: inline-block; color: #76c7d2;}.container .text + .text{margin-top: 8px;}.container .footer{position:fixed;display:block;bottom:100px;width:100%;left:0;text-align: center;}.container .footer>*{display:inline-block;height:40px}.container .footer .logo{width:40px;height:40px}.container .footer .logo img{width:100%}.container .footer span{font-size:18px;font-weight:bold;line-height:40px;color:#44c3ce;margin-left:10px}</style></head><body lang=\"zh-tw\"><div class=\"container\"><div class=\"image\"><img src=\"/asset/img/oops.png\"></div><span class=\"text\">您無權查看該網頁！</span><div class=\"footer\"><span>Maple<span></div></div></body></html>");' . "\n" . '' . "\n" . 'define("LN", "\n");' . "\n" . 'define("LR", "\r");' . "\n" . 'define("CLI_LEN", 80);' . "\n" . 'define("MAPLE", "4.0.1");' . "\n" . "\n" . '$tmp = explode(DIRECTORY_SEPARATOR, rtrim(dirname(__FILE__) . DIRECTORY_SEPARATOR, DIRECTORY_SEPARATOR));' . "\n" . 'array_pop($tmp);' . "\n" . "\n" . 'define("PATH", implode(DIRECTORY_SEPARATOR, $tmp) . DIRECTORY_SEPARATOR);' . "\n" . 'define("PATH_APP", PATH . "app" . DIRECTORY_SEPARATOR);' . "\n" . '' . "\n" . 'if (!function_exists("sr")) {' . "\n" . '  function sr($input, $multiplier) {' . "\n" . '    return str_repeat($input, $multiplier);' . "\n" . '  }' . "\n" . '}' . "\n" . '' . "\n" . 'if (!function_exists("cc")) {' . "\n" . '  function cc($str, $fontColor = null, $backgroundColor = null, $options = []) {' . "\n" . '    if ($str === "")' . "\n" . '      return "";' . "\n" . '' . "\n" . '    $colors = ["n" => "30", "r" => "31", "g" => "32", "y" => "33", "b" => "34", "p" => "35", "c" => "36", "w" => "37"];' . "\n" . '    $styles = ["underline" => "4", "blink" => "5", "reverse" => "7", "hidden" => "8", "u" => "4", "b" => "5", "r" => "7", "h" => "8"];' . "\n" . '' . "\n" . '    $tmps = [];' . "\n" . '' . "\n" . '    is_array($options) || $options = array_filter(array_map("trim", explode(",", $options)));' . "\n" . '' . "\n" . '    if ($options = array_map("strtolower", $options))' . "\n" . '      foreach ($options as $style)' . "\n" . '        isset($styles[$style]) && array_push($tmps, ["\033[" . $styles[$style] . "m", "\033[0m"]);' . "\n" . '' . "\n" . '    if ($backgroundColor !== null) {' . "\n" . '      $c = $backgroundColor[0];' . "\n" . '      $c = strtolower($c);' . "\n" . '      isset($colors[$c]) && array_push($tmps, ["\033[" . ($colors[$c] + 10) . "m", "\033[0m"]);' . "\n" . '    }' . "\n" . '' . "\n" . '    if ($fontColor !== null) {' . "\n" . '      strlen($fontColor) > 1 || $fontColor .= "_";' . "\n" . '      list($c, $w) = str_split($fontColor);' . "\n" . '' . "\n" . '      $w = $w === "_" ? ctype_upper($c) ? "2" : $w : $w;' . "\n" . '      $c = strtolower($c);' . "\n" . '' . "\n" . '      in_array($w, ["0", "1", "2"]) || $w = "1";' . "\n" . '      $w = $w !== "0" ? $w === "1" ? "0" : "1" : "2";' . "\n" . '' . "\n" . '      isset($colors[$c]) && array_push($tmps, ["\033[" . $w . ";" . $colors[$c] . "m", "\033[0m"]);' . "\n" . '    }' . "\n" . '' . "\n" . '    foreach ($tmps as $tmp)' . "\n" . '      $str = $tmp[0] . $str . $tmp[1];' . "\n" . '' . "\n" . '    return $str;' . "\n" . '  }' . "\n" . '}' . "\n" . '' . "\n" . 'if (!function_exists("config")) {' . "\n" . '  function config() {' . "\n" . '    static $files, $keys;' . "\n" . '' . "\n" . '    if (!$args = func_get_args())' . "\n" . '      exit("Config 使用方式錯誤！");' . "\n" . '' . "\n" . '    $fileName = array_shift($args);' . "\n" . '    $argsStr  = implode("", $args);' . "\n" . '' . "\n" . '    if (isset($keys[$fileName . $argsStr]))' . "\n" . '      return $keys[$fileName . $argsStr];' . "\n" . '' . "\n" . '    if (!isset($files[$fileName])) {' . "\n" . '      if (!file_exists($path = PATH_APP . "config" . DIRECTORY_SEPARATOR . ENVIRONMENT . DIRECTORY_SEPARATOR . $fileName . ".php") && !file_exists($path = PATH_APP . "config" . DIRECTORY_SEPARATOR . $fileName . ".php"))' . "\n" . '        exit("檔案名稱為「" . $fileName . "」的 Config 檔案不存在！");' . "\n" . '' . "\n" . '      $files[$fileName] = include_once($path);' . "\n" . '    }' . "\n" . '' . "\n" . '    $tmp = $files[$fileName];' . "\n" . '' . "\n" . '    foreach ($args as $arg)' . "\n" . '      if (($tmp = isset($tmp[$arg]) ? $tmp[$arg] : null) === null)' . "\n" . '        break;' . "\n" . '' . "\n" . '    return $keys[$fileName . $argsStr] = $tmp;' . "\n" . '  }' . "\n" . '}' . "\n" . '' . "\n" . 'if (!function_exists("isJson")) {' . "\n" . '  function isJson(&$string, $array = true) {' . "\n" . '   $string = json_decode($string, $array);' . "\n" . '   return json_last_error() === JSON_ERROR_NONE;' . "\n" . '  }' . "\n" . '}' . "\n" . '' . "\n" . '$tmp = @include_once PATH . "env.php";' . "\n" . '' . "\n" . '$tmp || exit(LN . cc(sr("─", CLI_LEN), "W", "r") . LN . cc(sr(" ", CLI_LEN), "w0", "r") . LN . cc(" 警告！ ", "Y", "r") . cc("載入環境常數失敗！" . sr(" ", CLI_LEN - 26), "W", "r") . LN . cc(sr(" ", CLI_LEN), "w0", "r") . LN . cc(sr("─", CLI_LEN), "W", "r") . LN . LN);' . "\n" . '' . "\n" . 'foreach (config("deploy") as $conf) {' . "\n" . '  $host = host($conf["stage"])->hostname($conf["host"])->user($conf["user"]);' . "\n" . '' . "\n" . '  foreach (["port", "path", "name", "remote", "branch", "migration"] as $key)' . "\n" . '    empty($conf[$key]) || $host->set($key, $conf[$key]);' . "\n" . '}' . "\n" . '' . "\n" . 'task("deploy:check", function() {' . "\n" . '  $name = get("name", "");' . "\n" . '  $path = get("path", [null]);' . "\n" . '' . "\n" . '  echo LN . cc(" 【檢查" . $name . "環境】", "y") . LN;' . "\n" . '' . "\n" . '  $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "檢查目錄變數 " . cc("path", "w2");' . "\n" . '  echo $title . cc("… ", "w0");' . "\n" . '  is_string($path) || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "請設定" . ($name ? cc($name, "W") . "的" : "") . " " . cc("path", "w2") . " 值" . LN . LN);' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  try {' . "\n" . '    $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "檢查是否可以連線";' . "\n" . '    echo $title . cc("… ", "w0");' . "\n" . '    run("pwd");' . "\n" . '  } catch (\Exception $exception) {' . "\n" . '    exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "請確認連線資訊是否完成" . LN . LN);' . "\n" . '  }' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  $path = rtrim(get("path"), "/");' . "\n" . '' . "\n" . '  $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "檢查目錄是否存在";' . "\n" . '  echo $title . cc("… ", "w0");' . "\n" . '  test("[ -d " . $path . " ]") || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "請確定目錄 " . cc($path, "W")  . " 是否存在" . LN . LN);' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "檢查是否有 Git 管理";' . "\n" . '  echo $title . cc("… ", "w0");' . "\n" . '  test("[ -d " . $path . "/.git ]") || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "專案內沒有 " . cc(".git", "w2") . " 目錄！" . LN . LN);' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  try {' . "\n" . '    $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "檢查是否有 " . cc("Git 指令", "p");' . "\n" . '    echo $title . cc("… ", "w0");' . "\n" . '    $git = locateBinaryPath("git");' . "\n" . '  } catch (\Exception $exception) {' . "\n" . '    exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "請確認伺服器可以執行 " . cc("git", "w2") . " 指令" . LN . LN);' . "\n" . '  }' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  try {' . "\n" . '    $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "檢查是否有 " . cc("PHP 指令", "p");' . "\n" . '    echo $title . cc("… ", "w0");' . "\n" . '    $php = locateBinaryPath("php");' . "\n" . '  } catch (\Exception $exception) {' . "\n" . '    exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "請確認伺服器可以執行 " . cc("php", "w2") . " 指令" . LN . LN);' . "\n" . '  }' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  try {' . "\n" . '    $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "檢查是否有 " . cc("Maple 指令", "p");' . "\n" . '    echo $title . cc("… ", "w0");' . "\n" . '    $maple = locateBinaryPath("maple");' . "\n" . '  } catch (\Exception $exception) {' . "\n" . '    exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "請確認伺服器可以執行 " . cc("maple", "w2") . " 指令" . LN . LN);' . "\n" . '  }' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  $path = $path ? $path . "/" : "";' . "\n" . '' . "\n" . '  $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "檢查" . cc("部署目錄", "w2") . "是否存在";' . "\n" . '  echo $title . cc("… ", "w0");' . "\n" . '  if (!test("[ -d " . $path . ".release/" . " ]")) {' . "\n" . '    echo $title . cc(" ─ ", "N") . cc("失敗", "r") . LN;' . "\n" . '    $title = LR . sr(" ", 6) . cc("➤ ", "c2") . "新增部署目錄";' . "\n" . '    echo $title . cc("… ", "w0");' . "\n" . '    run("mkdir " . $path . ".release");' . "\n" . '    test("[ -d " . $path . ".release/" . " ]") || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 7) . cc(" ◎ ", "p2") . "請手動新增" . cc("部署目錄", "w2") . "(.release)" . LN . LN);' . "\n" . '    echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '  } else {' . "\n" . '    echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '  }' . "\n" . '' . "\n" . '  $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "檢查" . cc("部署紀錄", "w2") . "是否存在";' . "\n" . '  echo $title . cc("… ", "w0");' . "\n" . '  if (!test("[ -f " . $path . ".release/note.log" . " ]")) {' . "\n" . '    echo $title . cc(" ─ ", "N") . cc("失敗", "r") . LN;' . "\n" . '    $title = LR . sr(" ", 6) . cc("➤ ", "c2") . "新增部署紀錄";' . "\n" . '    echo $title . cc("… ", "w0");' . "\n" . '' . "\n" . '    run("touch " . $path . ".release/note.log");' . "\n" . '    test("[ -f " . $path . ".release/note.log" . " ]") || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 7) . cc(" ◎ ", "p2") . "請手動新增" . cc("部署紀錄", "w2") . "(.release/note.log)" . LN . LN);' . "\n" . '    echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '  } else {' . "\n" . '    echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '  }' . "\n" . '' . "\n" . '})->shallow()->setPrivate();' . "\n" . '' . "\n" . 'task("deploy:gitPull", function() {' . "\n" . '  $path = rtrim(get("path"), "/");' . "\n" . '' . "\n" . '  echo LN . " " . cc("【Git Pull】", "y") . LN;' . "\n" . '' . "\n" . '  $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "進入專案目錄：" . cc($path, "W");' . "\n" . '  echo $title . cc("… ", "w0");' . "\n" . '  cd($path);' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  try {' . "\n" . '    $git = locateBinaryPath("git");' . "\n" . '    $remote = get("remote", "origin");' . "\n" . '    $branch = get("branch", "master");' . "\n" . '    $cmd = "pull" . ($remote ? " " . $remote : "") . ($branch ? " " . $branch : "");' . "\n" . '    $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "執行指令：" . cc("git " . $cmd, "W");' . "\n" . '    echo $title . cc("… ", "w0");' . "\n" . '    run("$git " . $cmd);' . "\n" . '  } catch (\Exception $exception) {' . "\n" . '    exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "執行 git " . $cmd . " 指令失敗！" . LN . LN);' . "\n" . '  }' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '})->shallow()->setPrivate();' . "\n" . '' . "\n" . 'task("deploy:migration", function() {' . "\n" . '  $path = rtrim(get("path"), "/");' . "\n" . '  $migration = get("migration", "");' . "\n" . '' . "\n" . '  echo LN . " " . cc("【Migration】", "y") . LN;' . "\n" . '' . "\n" . '  $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "進入專案目錄：" . cc($path, "W");' . "\n" . '  echo $title . cc("… ", "w0");' . "\n" . '  cd($path);' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  $func = function() {' . "\n" . '    try {' . "\n" . '      $maple = locateBinaryPath("maple");' . "\n" . '      $cmd = "maple migration new";' . "\n" . '      $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "執行指令：" . cc($cmd, "W");' . "\n" . '      echo $title . cc("… ", "w0");' . "\n" . '      $res = run("$maple migration new --deploy");' . "\n" . '      isJson($res) && isset($res["status"], $res["msgs"], $res["now"]) || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "錯誤原因：" . cc("回傳結構有誤", "w2") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "回傳結果：" . cc($res, "w2") . LN . LN);' . "\n" . '      $res["status"] === 1 || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "目前版本：第 " . cc($res["now"], "w2") . " 版" . implode("", array_map(function($k, $v) { return LN . sr(" ", 5) . cc(" ◎ ", "p2") . $k . "：" . cc($v, "w2"); }, array_keys($res["msgs"]), array_values($res["msgs"]))) . LN . LN);' . "\n" . '    } catch (\Exception $exception) {' . "\n" . '      exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "執行 maple " . $cmd . " 指令失敗！" . LN . LN);' . "\n" . '    }' . "\n" . '    echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '    $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "確認目前 Migration 版本";' . "\n" . '    echo $title . cc("… ", "w0");' . "\n" . '    echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '    echo sr(" ", 5) . cc(" ◎ ", "p2") . "目前版本為第 " . cc($res["now"], "W") . " 版" . LN;' . "\n" . '  };' . "\n" . '' . "\n" . '  if (!(is_array($migration) && isset($migration["branch"])))' . "\n" . '    return $func();' . "\n" . '' . "\n" . '  try {' . "\n" . '    $git = locateBinaryPath("git");' . "\n" . '' . "\n" . '    $cmd = "fetch";' . "\n" . '    $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "更新 Git，執行指令：" . cc("git " . $cmd, "W");' . "\n" . '    echo $title . cc("… ", "w0");' . "\n" . '    run("$git " . $cmd);' . "\n" . '  } catch (\Exception $exception) {' . "\n" . '    exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "執行 git " . $cmd . " 指令失敗！" . LN . LN);' . "\n" . '  }' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  try {' . "\n" . '    $git = locateBinaryPath("git");' . "\n" . '    $branch = $migration["branch"];' . "\n" . '' . "\n" . '    $cmd = "checkout " . $branch;' . "\n" . '    $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "切換到分支「" . cc($branch, "w2") . "」，執行指令：" . cc("git " . $cmd, "W");' . "\n" . '    echo $title . cc("… ", "w0");' . "\n" . '    run("$git " . $cmd);' . "\n" . '  } catch (\Exception $exception) {' . "\n" . '    exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "執行 git " . $cmd . " 指令失敗！" . LN . LN);' . "\n" . '  }' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  try {' . "\n" . '    $git = locateBinaryPath("git");' . "\n" . '    $remote = empty($migration["remote"]) ? "" : $migration["remote"];' . "\n" . '    $branch = $migration["branch"];' . "\n" . '' . "\n" . '    $cmd = "pull" . ($remote ? " " . $remote : "") . " " . $branch;' . "\n" . '    $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "更新分支，執行指令：" . cc("git " . $cmd, "W");' . "\n" . '    echo $title . cc("… ", "w0");' . "\n" . '    run("$git " . $cmd);' . "\n" . '  } catch (\Exception $exception) {' . "\n" . '    exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "執行 git " . $cmd . " 指令失敗！" . LN . LN);' . "\n" . '  }' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  $func();' . "\n" . '' . "\n" . '  try {' . "\n" . '    $git = locateBinaryPath("git");' . "\n" . '    $branch = get("branch", "master");' . "\n" . '    $cmd = "checkout " . $branch;' . "\n" . '    $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "切回專案，執行指令：" . cc("git " . $cmd, "W");' . "\n" . '    echo $title . cc("… ", "w0");' . "\n" . '    run("$git " . $cmd);' . "\n" . '  } catch (\Exception $exception) {' . "\n" . '    exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "執行 git " . $cmd . " 指令失敗！" . LN . LN);' . "\n" . '  }' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '})->shallow()->setPrivate();' . "\n" . '' . "\n" . 'task("deploy:clean", function() {' . "\n" . '  $path = rtrim(get("path"), "/");' . "\n" . '' . "\n" . '  echo LN . " " . cc("【清除 Cache】", "y") . LN;' . "\n" . '' . "\n" . '  $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "進入專案目錄：" . cc($path, "W");' . "\n" . '  echo $title . cc("… ", "w0");' . "\n" . '  cd($path);' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  $dirs = [' . "\n" . '    "Cache" => "cache",' . "\n" . '    "Tmp" => "tmp",' . "\n" . '    "Session" => "session",' . "\n" . '  ];' . "\n" . '' . "\n" . '  $maple = locateBinaryPath("maple");' . "\n" . '  foreach ($dirs as $title => $dir) {' . "\n" . '    try {' . "\n" . '      $cmd = "maple clean " . $dir;' . "\n" . '      $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "清空 " . cc($title . " 目錄", "p") . "，執行指令：" . cc($cmd, "W");' . "\n" . '      echo $title . cc("… ", "w0");' . "\n" . '      $res = run("$maple clean " . $dir . " --deploy");' . "\n" . '      isJson($res) && isset($res["status"], $res["msgs"]) || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "錯誤原因：" . cc("回傳結構有誤", "w2") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "回傳結果：" . cc($res, "w2") . LN . LN);' . "\n" . '      $res["status"] === 1 || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . implode("", array_map(function($k, $v) { return LN . sr(" ", 5) . cc(" ◎ ", "p2") . $k . "：" . (is_array($v) ? LN . implode(LN, array_map(function($t) { return sr(" ", 7) . cc(" ※ ", "b2") . "檔案位置：" . $t; }, $v)) : cc($v, "w2")); }, array_keys($res["msgs"]), array_values($res["msgs"]))) . LN . LN);' . "\n" . '    } catch (\Exception $exception) {' . "\n" . '      exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "執行 maple " . $cmd . " 指令失敗！" . LN . LN);' . "\n" . '    }' . "\n" . '    echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '  }' . "\n" . '})->shallow()->setPrivate();' . "\n" . '' . "\n" . 'task("deploy:lock", function() {' . "\n" . '  $path = rtrim(get("path"), "/");' . "\n" . '  $path = $path ? $path . "/" : "";' . "\n" . '  $userName = get_current_user();' . "\n" . '' . "\n" . '  echo LN . cc(" 【鎖定專案】", "y") . LN;' . "\n" . '' . "\n" . '  $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "檢查專案是否有被鎖定";' . "\n" . '  test("[ -f " . $path . ".release/deploy.lock ]") && exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "專案已被鎖定" . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "請確認上次失敗原因" . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "解鎖就將 .release/deploy.lock 刪除" . LN . LN);' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "新增" . cc("開始", "w2") . "的部署紀錄";' . "\n" . '  echo $title . cc("… ", "w0");' . "\n" . '  run("echo \"\" >> " . $path . ".release/note.log");' . "\n" . '  run("echo \"" . date("Y-m-d H:i:s") . " | 開始部署 | " . $userName . "\" >> " . $path . ".release/note.log");' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '' . "\n" . '  $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "新增鎖定紀錄";' . "\n" . '  run("echo \"" . date("Y-m-d H:i:s") . " | 開始部署 | " . $userName . "\" >> " . $path . ".release/deploy.lock");' . "\n" . '  test("[ -f " . $path . ".release/deploy.lock ]") || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "新增鎖定紀錄失敗" . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "請檢查部署工具" . LN . LN);' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '})->shallow()->setPrivate();' . "\n" . '' . "\n" . 'task("deploy:unlock", function() {' . "\n" . '  $path = rtrim(get("path"), "/");' . "\n" . '  $path = $path ? $path . "/" : "";' . "\n" . '  $userName = get_current_user();' . "\n" . '' . "\n" . '  echo LN . cc(" 【解鎖專案】", "y") . LN;' . "\n" . '' . "\n" . '  $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "解鎖專案";' . "\n" . '  if ($exist = test("[ -f " . $path . ".release/deploy.lock ]")) {' . "\n" . '    run("rm -f " . $path . ".release/deploy.lock");' . "\n" . '    test("[ -f " . $path . ".release/deploy.lock ]") && exit($title . cc(" ─ ", "N") . cc("失敗", "r") . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "刪除 .release/deploy.lock 失敗" . LN . sr(" ", 5) . cc(" ◎ ", "p2") . "請手動刪除 .release/deploy.lock" . LN . LN);' . "\n" . '  }' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '  echo !$exist ? sr(" ", 5) . cc(" ◎ ", "p2") . "未執行刪除" . LN : "";' . "\n" . '  echo !$exist ? sr(" ", 5) . cc(" ◎ ", "p2") . "因為 .release/deploy.lock 不存在" . LN : "";' . "\n" . '  echo !$exist ? sr(" ", 5) . cc(" ◎ ", "p2") . "但已完成解鎖專案" . LN : "";' . "\n" . '' . "\n" . '  $title = LR . sr(" ", 4) . cc("➤ ", "c2") . "新增" . cc("結束", "w2") . "的部署紀錄";' . "\n" . '  echo $title . cc("… ", "w0");' . "\n" . '  run("echo \"" . date("Y-m-d H:i:s") . " | 結束部署 | " . $userName . "\" >> " . $path . ".release/note.log");' . "\n" . '  echo $title . cc(" ─ ", "N") . cc("完成", "g") . LN;' . "\n" . '})->shallow()->setPrivate();' . "\n" . '' . "\n" . 'task("deploy", [' . "\n" . '  "deploy:check",' . "\n" . '  "deploy:lock",' . "\n" . '  "deploy:gitPull",' . "\n" . '  "deploy:migration",' . "\n" . '  "deploy:clean",' . "\n" . '  "deploy:unlock",' . "\n" . '])->shallow();' . "\n" . '' . "\n" . 'task("deploy:success", function() {' . "\n" . '  echo LN;' . "\n" . '  echo cc(" 【更新完成】", "R") . LN;' . "\n" . '  echo sr(" ", 4) . cc("➤ ", "c2") . "已經更新成功囉！" . LN;' . "\n" . '  echo sr(" ", 4) . cc("➤ ", "c2") . "目前已經是最新版囉！趕緊打開頁面看看吧！" . LN;' . "\n" . '  echo LN;' . "\n" . '})->shallow()->setPrivate();' . "\n" . '' . "\n" . 'after("deploy", "deploy:success");' . "\n" . '' . "\n", 'wb') || exit($title . cc(" ─ ", "N") . cc("失敗", "r") . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "無法寫入檔案" . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "請檢查 tmp 目錄的權限配置" . "\n" . "\n");
    echo $title . cc(" ─ ", "N") . cc("完成", "g") . "\n";

    $title = "\r" . sr(" ", 4) . cc("➤ ", "c2") . "檢查是否可執行 " . cc('dep', 'w2') . " 指令";
    echo $title . cc("… ", "w0");
    empty(shell_exec(sprintf("which %s", escapeshellarg('dep')))) && exit($title . cc(" ─ ", "N") . cc("失敗", "r") . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "請先安裝 dep 指令吧！" . "\n" . sr(" ", 5) . cc(" ◎ ", "p2") . "安裝方法：" . cc('https://deployer.org/docs', 'W', null, ['underline']) . "\n" . "\n");
    echo $title . cc(" ─ ", "N") . cc("完成", "g") . "\n";

    passthru('cd ' . PATH_TMP . ' && dep deploy ' . $stage);

    @unlink($path);
    exit;
  }
}

class Logo {
  private static $c;
  private static function c() { return self::$c = 'w'; }
  private static function ss($num, $str = ' ') { return cc(sr($str, $num), 'n'); }
  private static function f0($str) { return cc($str, self::c() . '0'); }
  private static function f1($str) { return cc($str, self::c() . '1'); }
  private static function f2($str) { return cc($str, self::c() . '2'); }

  public static function show() {
    $return = "\n";

    $return .= "\n";
    $return .= self::f2("   ███╗   ███╗ █████╗ ██████╗ ██╗     ███████╗ ") . "\n";
    $return .= self::f2("   ████╗ ████║██╔══██╗██╔══██╗██║     ██╔════╝ ") . "\n";
    $return .= self::f1("   ██╔████╔██║███████║██████╔╝██║     █████╗   ") . "\n";
    $return .= self::f1("   ██║╚██╔╝██║██╔══██║██╔═══╝ ██║     ██╔══╝   ") . "\n";
    $return .= self::f0("   ██║ ╚═╝ ██║██║  ██║██║     ███████╗███████╗ ") . "\n";
    $return .= self::f0("   ╚═╝     ╚═╝╚═╝  ╚═╝╚═╝     ╚══════╝╚══════╝ ") . "\n";
    $return .= sr(' ', 37) . cc('版本', 'w0') . " " . cc(VERSION, 'y') . "\n";

    return $return;
  }
}

function checkUpload() {
  $json = @file_get_contents('https://comdan66.github.io/Maple/version.json?=' . time());
  define('NEW_VERSION', isJson($json) && !empty($json['version']) && version_compare(VERSION, $json['version'], '<') ? $json['version'] : false);
};

($index = fileRead(PATH . 'index.php')) && preg_match_all('/define\s*\((["\'])(?P<kv>(?>[^"\'\\\]++|\\\.|(?!\1)["\'])*)\1?/', $index, $index) && $index['kv'] && in_array('MAPLE', $index['kv']) || exit("\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(' 警告！ ', 'Y', 'r') . cc('這不是 Maple 框架的專案吧！' . sr(' ', CLI_LEN - 35), 'W', 'r') . "\n" . cc(sr(' ', CLI_LEN), 'w0', 'r') . "\n" . cc(sr('─', CLI_LEN), 'W', 'r') . "\n\n");

checkUpload();

$path = array_shift($argv);

switch (strtolower(array_shift($argv))) {
  case 'init':      main('1', $argv); break;
  case 'create':    main('2', $argv); break;
  case 'migration': main('3', $argv); break;
  case 'clean':     main('4', $argv); break;
  case 'apidoc':    main('5', $argv); break;
  case 'deploy':    main('6', $argv); break;
  case 'update':    NEW_VERSION && main('7', $argv); break;
  default:          main();    break;
}
